

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>День третий - обучение без учителя* &#8212; ML introduction</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-dropdown.css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="День четвертый - нейросети (изображения, тексты, многомерные ряды)" href="day_4.html" />
    <link rel="prev" title="День второй - анализ данных" href="day_2.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  
  <h1 class="site-logo" id="site-title">ML introduction</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="README.html">
   Курс “Введение в анализ данных и машинное обучение”
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="day_1.html">
   День первый, обзорный
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="day_2.html">
   День второй - анализ данных
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   День третий - обучение без учителя*
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="day_4.html">
   День четвертый - нейросети (изображения, тексты, многомерные ряды)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="day_5.html">
   День пятый - интерпретация, внедрение и другие темы
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cheatsheet.html">
   Как делать проекты
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="maths_behind.html">
   Визуально о математике, стоящей за некоторыми алгоритмами
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="recipes_book.html">
   Сборник полезных рецептов
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="self_check.html">
   Вопросы для самопроверки
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/day_3.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/day_3.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/executablebooks/jupyter-book/blob/master/day_3.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   3.1 Отбор признаков и поиск гиперпараметров
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Отбор признаков
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     В качестве заключения
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id5">
   3.2 Понижение размерности
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#principal-component-analysis-pca">
     Principal component analysis (PCA)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Заключение
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id7">
   3.3 Кластеризация
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     В качестве заключения
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id9">
   3.4 Поиск аномалий в данных
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     Заключение
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id11">
   3.5 Одномерные временные ряды
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id12">
     Заключение
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id13">
   3.6 Стэкинг, или объединение нескольких моделей
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id14">
     Заключение
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="id1">
<h1>День третий - обучение без учителя*<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>* и некоторые другие темы</p>
<p>В сегодняшнем дне нас ждут следующие темы:</p>
<ol class="simple">
<li><p>Немного про отбор признаков и про поиск гиперпараметров,</p></li>
<li><p>Задача понижения размерности данных,</p></li>
<li><p>Кластеризация,</p></li>
<li><p>Поиск аномалий в данных,</p></li>
<li><p>Одномерные временные ряды с помощью библиотеки <code class="docutils literal notranslate"><span class="pre">Facebook</span> <span class="pre">Prophet</span></code>,</p></li>
<li><p>Что такое стэкинг и как предсказания моделей использовать как вход для других моделей.</p></li>
</ol>
<div class="section" id="id2">
<h2>3.1 Отбор признаков и поиск гиперпараметров<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>В прошлых днях мы видели, что есть хорошие и не очень хорошие признаки, которые дают прирост качеству модели, или наоборот её ухудшают. Так же мы немного наивно выставляли какие-то числа в модель - количество соседей, количество нейронов в слоях… то, что называется <em>гиперпараметрами модели</em>, при этом делали это несколько от потолка.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># загрузим наш датасет ракушек</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/abalone.csv&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sex</th>
      <th>length</th>
      <th>diameter</th>
      <th>height</th>
      <th>whole weight</th>
      <th>shucked weight</th>
      <th>viscera weight</th>
      <th>shell weight</th>
      <th>rings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>M</td>
      <td>0.455</td>
      <td>0.365</td>
      <td>0.095</td>
      <td>0.5140</td>
      <td>0.2245</td>
      <td>0.1010</td>
      <td>0.150</td>
      <td>15</td>
    </tr>
    <tr>
      <th>1</th>
      <td>M</td>
      <td>0.350</td>
      <td>0.265</td>
      <td>0.090</td>
      <td>0.2255</td>
      <td>0.0995</td>
      <td>0.0485</td>
      <td>0.070</td>
      <td>7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>F</td>
      <td>0.530</td>
      <td>0.420</td>
      <td>0.135</td>
      <td>0.6770</td>
      <td>0.2565</td>
      <td>0.1415</td>
      <td>0.210</td>
      <td>9</td>
    </tr>
    <tr>
      <th>3</th>
      <td>M</td>
      <td>0.440</td>
      <td>0.365</td>
      <td>0.125</td>
      <td>0.5160</td>
      <td>0.2155</td>
      <td>0.1140</td>
      <td>0.155</td>
      <td>10</td>
    </tr>
    <tr>
      <th>4</th>
      <td>I</td>
      <td>0.330</td>
      <td>0.255</td>
      <td>0.080</td>
      <td>0.2050</td>
      <td>0.0895</td>
      <td>0.0395</td>
      <td>0.055</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">shuffle</span>

<span class="c1"># преобразуем наш категориальный признак</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sex</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;rings&#39;</span>
<span class="n">features</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="n">features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F&#39;,
 &#39;I&#39;,
 &#39;M&#39;,
 &#39;length&#39;,
 &#39;diameter&#39;,
 &#39;height&#39;,
 &#39;whole weight&#39;,
 &#39;shucked weight&#39;,
 &#39;viscera weight&#39;,
 &#39;shell weight&#39;]
</pre></div>
</div>
</div>
</div>
<div class="section" id="id3">
<h3>Отбор признаков<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Мы рассмотрим два метода - отбор с помощью взаимной информации между признаками, и отбор с помощью моделей. Начнем с взаимной информации. Строгого определение по сложившейся традиции тут приведено не будет, важно знать, что это <em>неотрицательное число</em>, равное 0 тогда и только когда, когда связи между признаками нет никакой. В свою очередь, чем оно больше - тем выше связь.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">mutual_info_regression</span><span class="p">,</span> <span class="n">SelectKBest</span>

<span class="n">train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># для классификации есть mutual_info_classif</span>

<span class="n">regression_best_features</span> <span class="o">=</span> <span class="n">SelectKBest</span><span class="p">(</span><span class="n">mutual_info_regression</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">[</span><span class="n">features</span><span class="p">][:</span><span class="n">train</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">][:</span><span class="n">train</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_support</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># этот метод возращает номера колонок</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Если кольца считать как регрессию, лучшие 4 признака это&quot;</span><span class="p">,</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)[</span><span class="n">regression_best_features</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Если кольца считать как регрессию, лучшие 4 признака это [&#39;length&#39; &#39;diameter&#39; &#39;whole weight&#39; &#39;shell weight&#39;]
</pre></div>
</div>
</div>
</div>
<p>Что ж, посчитаем регрессию и классификацию на этих четырех признаках.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPRegressor</span>

<span class="n">regressor</span> <span class="o">=</span> <span class="n">MLPRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="n">regression_best_features</span><span class="p">][:</span><span class="n">train</span><span class="p">],</span>
    <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">][:</span><span class="n">train</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2 test regression </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">r2_score</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">train</span><span class="p">:],</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="n">regression_best_features</span><span class="p">][</span><span class="n">train</span><span class="p">:]))</span>
<span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R2 test regression 0.479
</pre></div>
</div>
</div>
</div>
<p>Вот так можно отбирать признаки в задачах регрессии (и классификации тоже) с помощью взаимной информации. Но можно делать это еще интересней - с помощью других моделей!</p>
<blockquote>
<div><p>Для моделей часто важна интерпретируемость! Мы об это будем обязательно говорить. Линейные модели и деревья - интерпретируемы, нейросети с трудом или практически нет.</p>
</div></blockquote>
<p><strong>Интерпретируемость</strong> означает, что мы можем понять, что даёт наибольший вклад в предсказания. Она может быть локальной - в одном примере, а может быть глобальной - для всей модели. Так, деревья имеют после подгонки определенные коэффициенты важности, они же <code class="docutils literal notranslate"><span class="pre">tree_estimator.feature_importances_</span></code>, которые показывают, какой признак даёт наибольший вклад в предсказание. С линейными моделями - еще проще, там коэффициенты при признаках указывают на вклад (но учитывайте единицы измерения!).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">SelectFromModel</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="n">selector_linear</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">LinearRegression</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">[</span><span class="n">features</span><span class="p">][:</span><span class="n">train</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">][:</span><span class="n">train</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">selector_forest</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">[</span><span class="n">features</span><span class="p">][:</span><span class="n">train</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">][:</span><span class="n">train</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">linear_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)[</span><span class="n">selector_linear</span><span class="o">.</span><span class="n">get_support</span><span class="p">()]</span>
<span class="n">forest_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)[</span><span class="n">selector_forest</span><span class="o">.</span><span class="n">get_support</span><span class="p">()]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;По линейной модели&quot;</span><span class="p">,</span> <span class="n">linear_features</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;По случайному лесу&quot;</span><span class="p">,</span> <span class="n">forest_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>По линейной модели [&#39;F&#39; &#39;I&#39; &#39;M&#39;]
По случайному лесу [&#39;shucked weight&#39; &#39;shell weight&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2 по линейным признакам </span><span class="si">%.3f</span><span class="s2"> (test set)&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">r2_score</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">train</span><span class="p">:],</span>
        <span class="n">MLPRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">linear_features</span><span class="p">][:</span><span class="n">train</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">][:</span><span class="n">train</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">linear_features</span><span class="p">][</span><span class="n">train</span><span class="p">:]</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2 по признакам случайного леса </span><span class="si">%.3f</span><span class="s2"> (test set)&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">r2_score</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">train</span><span class="p">:],</span>
        <span class="n">MLPRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">forest_features</span><span class="p">][:</span><span class="n">train</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">][:</span><span class="n">train</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">forest_features</span><span class="p">][</span><span class="n">train</span><span class="p">:]</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R2 по линейным признакам 0.201 (test set)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R2 по признакам случайного леса 0.537 (test set)
</pre></div>
</div>
</div>
</div>
<p>Как видим, линейные модели сильно проиграли случайному лесу в отборе признаков на текущих данных.</p>
<p>Заметим, мы использовали значения по умолчанию для <code class="docutils literal notranslate"><span class="pre">MLPRegressor</span></code>, хорошо ли это? Мы не знаем. Для того, чтобы попробовать сразу много вариантов, да еще и с кросс-валидацией, можно использовать встроенный в <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> класс <code class="docutils literal notranslate"><span class="pre">GridSearchCV</span></code>, который осуществляет <em>перебор по сетке гиперпараметров</em>.</p>
<p>Можно показать как это работает на примере.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>

<span class="c1"># перебор всех сочетаний параметров</span>
<span class="c1"># это может занимать много времени!</span>

<span class="n">search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">KNeighborsRegressor</span><span class="p">(),</span>
    <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span>
        <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="n">cv</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="p">)</span>

<span class="s1">&#39;лучший отобранный по кросс-валидации&#39;</span><span class="p">,</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span><span class="p">,</span> \
<span class="s1">&#39;наилучшее значение метрики (R2) </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">search</span><span class="o">.</span><span class="n">best_score_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;лучший отобранный по кросс-валидации&#39;,
 KNeighborsRegressor(n_neighbors=25, weights=&#39;distance&#39;),
 &#39;наилучшее значение метрики (R2) 0.540&#39;)
</pre></div>
</div>
</div>
</div>
<p>Как видим, ближайшие соседи могут даже сравниться с нейросетями.</p>
<blockquote>
<div><p>Имейте в виду! Когда мы отобрали по кросс-валидации лучшие гиперпараметры, перед отправкой модели в <em>среду эксплуатации</em> (для работы сайта например), мы можем её обучить с найденными параметрами уже на всех данных. Хуже от этого она предсказывать не будет - если вы, конечно, почистили данные от выбросов.</p>
</div></blockquote>
</div>
<div class="section" id="id4">
<h3>В качестве заключения<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Не стоит в любом случае сильно увлекаться автоматическими отборами и переборами - разведочный анализ пропускать нельзя. Но если признаков не 5 и не 10, эти методы могут сослужить хорошую службу. Их даже можно объединять в так называемые <code class="docutils literal notranslate"><span class="pre">pipelines</span></code>, то есть соединять последовательно (и далее мы это будем делать).</p>
</div>
</div>
<div class="section" id="id5">
<h2>3.2 Понижение размерности<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Задача понижения размерности - это задача обучения без учителя, то есть когда у нас <strong>нет правильных ответов</strong>. Решение задач без разметки ответов часто используется для анализа и предобработки, например для отображения сложных данных.</p>
<p>Понижение размерности - это сжатие признаков датасета до более меньшего количества (размерности), при попытке не потерять информацию в них и их полезные свойства.</p>
<div class="section" id="principal-component-analysis-pca">
<h3>Principal component analysis (PCA)<a class="headerlink" href="#principal-component-analysis-pca" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">PCA</span></code> - это линейное преобразование (то есть <span class="math notranslate nohighlight">\(y_j = \sum k_{ij} x_i + b_j\)</span>) всех признаков данных, с целью оставить в них как больше информации - а точнее, оставить как можно больше разброса в величинах. Главная компонента - это направление в данных, в котором разброс (вариабельность) этих самых данных наибольшая (и далее берется следующее направление). Направлений столько, сколько признаков в данных.</p>
<blockquote>
<div><p><strong>ВАЖНО</strong>: поскольку <code class="docutils literal notranslate"><span class="pre">PCA</span></code> работает с разбросом, все величины надо стандартизировать (вычесть среднее и разделить на разброс), чтобы привести к единой шкале!</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="c1"># отобразим все признаки кроме колец на плоскость</span>
<span class="n">PCA</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">transformed</span> <span class="o">=</span> <span class="n">PCA</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">transformed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transformed</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_20_0.png" src="_images/day_3_20_0.png" />
</div>
</div>
<p>Вот как-то так. Являются ли полученные полосы разделением по полам?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">transformed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transformed</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_22_0.png" src="_images/day_3_22_0.png" />
</div>
</div>
<p>Какой из этого можно сделать вывод? Что данные хорошо разделяются по полам? Нет, не такой вывод, но то, что пол - это одно из важнейших различий в данных. И, возможно, имеет смысл делать три модели для каждого пола.</p>
<p>Существует достаточно сложный метод <code class="docutils literal notranslate"><span class="pre">UMAP</span></code>, который укладывает на плоскость все данные (может и в более высокие размерности, но не более размерности данных). Не так сейчас важно как он работает в теории (в теории он ищет меньший граф связей, похожий на полученный из данных, активно при этом эксплуатируя важность ближайших для каждой точки данных), сколько важно посмотреть как он отработает на наших данных.</p>
<p>Суть в том, что он делает это нелинейно.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># запретим предупреждения</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">umap</span> <span class="kn">import</span> <span class="n">UMAP</span>

<span class="c1"># поступим аналогично</span>

<span class="n">transformed</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">UMAP</span><span class="p">()</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">transformed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transformed</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_25_0.png" src="_images/day_3_25_0.png" />
</div>
</div>
<p>Это, конечно, замечательно, но интересует, разделяются ли данные по полам, если эти признаки пола убрать?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transformed</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">UMAP</span><span class="p">()</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">features</span><span class="p">[</span><span class="mi">3</span><span class="p">:]])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">transformed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transformed</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_27_0.png" src="_images/day_3_27_0.png" />
</div>
</div>
<p>Как видим, не очень хорошо, и пол - это очень важный признак. Если бы мы хотели по остальным признакам различать пол, у нас бы это плохо получалось.</p>
<p>Для текстов тоже можно решать задачу понижения размерности, и можно с помощью <em>Латентного размещения Дирихле (LDA, Latent Dirichlet Allocation)</em>. Это позволит выделять тематическую направленность в текстах: тема будет состоять из самых общеупотребимых слов.</p>
<p>Давайте загрузим наш датасет <code class="docutils literal notranslate"><span class="pre">20</span> <span class="pre">newsgroups</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_20newsgroups</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span>
<span class="kn">from</span> <span class="nn">nltk.stem.snowball</span> <span class="kn">import</span> <span class="n">SnowballStemmer</span>
<span class="n">stemmer</span> <span class="o">=</span> <span class="n">SnowballStemmer</span><span class="p">(</span><span class="s2">&quot;english&quot;</span><span class="p">)</span>

<span class="n">data_all</span> <span class="o">=</span> <span class="n">fetch_20newsgroups</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">stop_words</span> <span class="kn">import</span> <span class="n">get_stop_words</span>
<span class="n">stop_words</span> <span class="o">=</span> <span class="n">get_stop_words</span><span class="p">(</span><span class="s1">&#39;en&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">clear_stops</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="n">stripped</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stripped</span> <span class="ow">in</span> <span class="n">stop_words</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">symbol</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="n">stripped</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stemmer</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">stripped</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="n">texts_all</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">clear_stops</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">data_all</span><span class="o">.</span><span class="n">data</span>
<span class="p">]</span>

<span class="n">text_vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span>
    <span class="n">min_df</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">max_df</span><span class="o">=</span><span class="mf">0.05</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">texts_all</span><span class="p">)</span>

<span class="n">vectors_all</span> <span class="o">=</span> <span class="n">text_vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">texts_all</span><span class="p">)</span>

<span class="n">vectors_all</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<p>Пусть мы хотим выделить 7 тем, и каждую охарактеризуем 10 словами.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">LatentDirichletAllocation</span> <span class="k">as</span> <span class="n">LDA</span>

<span class="c1"># это занимает некоторое время!</span>
<span class="n">lda</span> <span class="o">=</span> <span class="n">LDA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">vectors_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wall time: 1min 12s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Найденные темы&quot;</span><span class="p">)</span>

<span class="c1"># LDA требует нормировки своих компонент, тогда они &quot;покажут&quot; распределение слов</span>
<span class="n">normed</span> <span class="o">=</span> <span class="n">lda</span><span class="o">.</span><span class="n">components_</span> <span class="o">/</span> <span class="n">lda</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<span class="n">topics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">normed</span><span class="p">:</span>
    <span class="n">topic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">text_vectorizer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">())[[</span>
      <span class="n">feature</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">component</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="p">]]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">topic</span><span class="p">))</span>
    <span class="n">topics</span> <span class="o">+=</span> <span class="p">[</span><span class="n">topic</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Найденные темы
[&#39;fire&#39;, &#39;bike&#39;, &#39;children&#39;, &#39;fbi&#39;, &#39;love&#39;, &#39;__&#39;, &#39;hell&#39;, &#39;___&#39;, &#39;dod&#39;, &#39;koresh&#39;]
[&#39;key&#39;, &#39;space&#39;, &#39;encrypt&#39;, &#39;chip&#39;, &#39;nasa&#39;, &#39;secur&#39;, &#39;clipper&#39;, &#39;orbit&#39;, &#39;launch&#39;, &#39;develop&#39;]
[&#39;card&#39;, &#39;disk&#39;, &#39;dos&#39;, &#39;driver&#39;, &#39;mac&#39;, &#39;speed&#39;, &#39;scsi&#39;, &#39;board&#39;, &#39;pc&#39;, &#39;monitor&#39;]
[&#39;israel&#39;, &#39;war&#39;, &#39;american&#39;, &#39;mr&#39;, &#39;jew&#39;, &#39;turkish&#39;, &#39;isra&#39;, &#39;muslim&#39;, &#39;arab&#39;, &#39;presid&#39;]
[&#39;team&#39;, &#39;jesus&#39;, &#39;player&#39;, &#39;win&#39;, &#39;hockey&#39;, &#39;season&#39;, &#39;christ&#39;, &#39;hit&#39;, &#39;fan&#39;, &#39;church&#39;]
[&#39;gun&#39;, &#39;human&#39;, &#39;moral&#39;, &#39;argument&#39;, &#39;evid&#39;, &#39;object&#39;, &#39;accept&#39;, &#39;truth&#39;, &#39;natur&#39;, &#39;agre&#39;]
[&#39;imag&#39;, &#39;version&#39;, &#39;ftp&#39;, &#39;display&#39;, &#39;server&#39;, &#39;user&#39;, &#39;code&#39;, &#39;format&#39;, &#39;color&#39;, &#39;applic&#39;]
</pre></div>
</div>
</div>
</div>
<p>И предскажем тему для первого текста. <strong>Кстати, как работает LDA</strong>? Ответ: сложно. Коротенько если - то по Байесу. Чуть подробнее если, то формулируется приор на размещение слов по темам (по распределению Дирихле), аналогично - по распределению документов по темам. Далее идёт максимизация вероятности отнесения слова к теме по параметрам этих распределений.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">examples</span> <span class="o">=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">([</span><span class="n">text</span><span class="p">[</span><span class="mi">200</span><span class="p">:</span><span class="mi">400</span><span class="p">]</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts_all</span><span class="p">[:</span><span class="n">examples</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># transform - возвращает (ненормированное) распределение уже топиков (а не слов)</span>
<span class="n">predicted_components</span> <span class="o">=</span> <span class="n">lda</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">text_vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">texts_all</span><span class="p">[:</span><span class="n">examples</span><span class="p">]))</span>    
<span class="n">predicted_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predicted_components</span><span class="p">)</span>

<span class="c1"># нормируем</span>
<span class="n">normed_args</span> <span class="o">=</span> <span class="n">predicted_components</span> <span class="o">/</span> <span class="n">predicted_components</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">topics</span><span class="p">)[</span>
    <span class="n">normed_args</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># здесь по нашим 7 темам выбираем наибольшее значение</span>
<span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;cogn one day seven holy. &gt;jesus also recogn holi days, like passover. act say &gt;that lay gentil necessary. &gt;the sabbath list, epistl instruct peopl &gt;to keep day, christian live among peopl &gt;keep day. l&#39;]

[[&#39;team&#39;, &#39;jesus&#39;, &#39;player&#39;, &#39;win&#39;, &#39;hockey&#39;, &#39;season&#39;, &#39;christ&#39;, &#39;hit&#39;, &#39;fan&#39;, &#39;church&#39;]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id6">
<h3>Заключение<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Методы понижения размерности могут и в основном используются для двух целей:</p>
<ol class="simple">
<li><p>Цели визуализации сложных данных,</p></li>
<li><p>Цели сокращения размерности задачи, то есть уменьшения количества входных признаков.</p></li>
</ol>
<p><strong>Учтите!</strong> Когда вы используете методы понижения размерности и собираетесь результат передавать в модель, <em>делайте для них <strong>подгонку только на тренировочном</strong> множестве</em>!</p>
</div>
</div>
<div class="section" id="id7">
<h2>3.3 Кластеризация<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>Кластеризация - задача обучения без учителя, в которой каждому примеру надо сопоставить номер группы (кластера) таким образом, чтобы схожие примеры были в одном кластере. Что значит схожие? Это означает близкие по некоторому расстоянию.</p>
<p>Расстояние:</p>
<ul class="simple">
<li><p>может быть евклидовым: <span class="math notranslate nohighlight">\(d(a, b) = \sqrt {\sum (a_i - b_i)^2}\)</span>,</p></li>
<li><p>косинусным: <code class="docutils literal notranslate"><span class="pre">d(a,</span> <span class="pre">b)</span> <span class="pre">=</span> <span class="pre">1</span> <span class="pre">-</span> <span class="pre">косинус</span> <span class="pre">угла</span> <span class="pre">между</span> <span class="pre">векторами</span> <span class="pre">(a,</span> <span class="pre">b)</span> <span class="pre">=</span></code> <span class="math notranslate nohighlight">\(1 - \frac { \sum a_i b_i } {\sqrt {\sum a_i ^2} \sqrt { \sum b_i^2}}\)</span>,</p></li>
<li><p>манхэттэнским (по координатным прямым между точками): <span class="math notranslate nohighlight">\(d(a, b) = \sum |a_i - b_i|\)</span>,</p></li>
<li><p>есть и другие расстояния.</p></li>
</ul>
<p>Но как можно найти кластеры в данных? Давайте рассмотрим алгоритм, который разбивает точки на заранее заданное число кластеров.</p>
<ol class="simple">
<li><p>На первом шаге мы инициализируем случайные центроиды кластеров (случайные точки),</p></li>
<li><p>Посчитаем расстояния между каждой точкой и центроидами,</p></li>
<li><p>Присвоим номера кластеров точкам по ближайшему расстоянию до конкретного центроида,</p></li>
<li><p>Пересчитаем центроиды как центры полученных кластеров,</p></li>
<li><p>Повторим шаги 2-4, пока центроиды не перестанут меняться.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>

<span class="c1"># заберем только признаки, и только последние два, перемешаем</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">load_iris</span><span class="p">(</span><span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">clustering</span><span class="p">(</span><span class="n">number_clusters</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># шаг 1 - случайная инициализация</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_clusters</span><span class="p">)</span>
    <span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">number_clusters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">previous</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">centroids</span><span class="p">):</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">centroids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
        <span class="c1"># шаг 2, считаем все расстояния</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">centroid</span> <span class="ow">in</span> <span class="n">centroids</span><span class="p">:</span>
            <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">distance</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">centroid</span><span class="p">)</span> \
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
            <span class="p">])</span>
        
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">number_clusters</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># шаг 3, присваеваем метки точкам</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
            <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">[:,</span> <span class="n">index</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        
        <span class="c1"># шаг 4, пересчитываем центроиды</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_clusters</span><span class="p">):</span>
            <span class="n">centroids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">X</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clusters</span> <span class="o">==</span> <span class="n">index</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="n">X</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clusters</span> <span class="o">==</span> <span class="n">index</span><span class="p">),</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="p">])</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">number_clusters</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">, изменение расстояния центроидов </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">iteration</span><span class="p">,</span> <span class="n">distance</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">centroids</span><span class="p">)</span>
        <span class="p">))</span>
    
    <span class="k">return</span> <span class="n">centroids</span><span class="p">,</span> <span class="n">clusters</span>
            
<span class="n">centroids</span><span class="p">,</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">clustering</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1, изменение расстояния центроидов 1.6271
2, изменение расстояния центроидов 0.1064
3, изменение расстояния центроидов 0.1023
4, изменение расстояния центроидов 0.0460
5, изменение расстояния центроидов 0.0828
6, изменение расстояния центроидов 0.1951
7, изменение расстояния центроидов 0.2680
8, изменение расстояния центроидов 0.8304
9, изменение расстояния центроидов 0.7299
10, изменение расстояния центроидов 0.3966
11, изменение расстояния центроидов 0.2829
12, изменение расстояния центроидов 0.1459
13, изменение расстояния центроидов 0.0431
14, изменение расстояния центроидов 0.0648
15, изменение расстояния центроидов 0.0220
16, изменение расстояния центроидов 0.0000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Кластеры и центроиды&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">clusters</span><span class="p">);</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">centroid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">centroids</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="s2">&quot;Центроид&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.25</span><span class="p">),</span>
        <span class="n">arrowprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;arrowstyle&quot;</span><span class="p">:</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">}</span>
    <span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_40_0.png" src="_images/day_3_40_0.png" />
</div>
</div>
<p>Всё то же самое, только лучше, умеет делать класс <code class="docutils literal notranslate"><span class="pre">KMeans</span></code> из библиотеки <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>. Посмотрим как он работает, но сперва узнаем, что для кластеризации тоже существуют метрики качества, и одна из самых интересных - это <em>метрика силуэта</em>, <code class="docutils literal notranslate"><span class="pre">silhouette_score</span></code>.</p>
<p>Метрика силуэта меняется от -1 (худший случай) до +1 (лучший), и показывает, насколько “хорошо” принадлежат точка своему кластеру (для всех данных - значение усредняется). Хорошо принадлежит, это значит расстояние до ближайшего кластера, отличного от кластера точки, больше расстояния до кластера самой точки. Или, еще проще, точка находится среди таких же.</p>
<p>Поэтому в случае, когда мы не знаем количество кластеров заранее, мы можем перебирать и сравнивать их по метрике силуэта.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_score</span>

<span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">best_number</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">whole_X</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span>
    <span class="n">load_iris</span><span class="p">(</span><span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># переберем от 22 кластеров до 2</span>
<span class="k">for</span> <span class="n">number_clusters</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">clusterer</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">number_clusters</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">whole_X</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">whole_X</span><span class="p">,</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
        <span class="n">best_number</span> <span class="o">=</span> <span class="n">number_clusters</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">: улучшение, метрика силуэта </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">number_clusters</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22: улучшение, метрика силуэта 0.278
18: улучшение, метрика силуэта 0.289
15: улучшение, метрика силуэта 0.295
14: улучшение, метрика силуэта 0.309
11: улучшение, метрика силуэта 0.317
10: улучшение, метрика силуэта 0.325
9: улучшение, метрика силуэта 0.341
8: улучшение, метрика силуэта 0.350
7: улучшение, метрика силуэта 0.359
6: улучшение, метрика силуэта 0.365
5: улучшение, метрика силуэта 0.489
4: улучшение, метрика силуэта 0.498
3: улучшение, метрика силуэта 0.553
2: улучшение, метрика силуэта 0.681
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;По всем признакам вот так неочевидно!&quot;</span><span class="p">);</span>
<span class="n">clusterer</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">best_number</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">whole_X</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">clusterer</span><span class="o">.</span><span class="n">labels_</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_43_0.png" src="_images/day_3_43_0.png" />
</div>
</div>
<p>Внезапно оказалось, что два кластера - это лучшее разбиение точек на группы с точки зрения метрики силуэта! То есть делить цветы на три сорта не факт что правильно, так как две группы очень схожи.</p>
<p>Есть методы, которые заранее не требуют задавать количество кластеров, и мы такой рассмотрим, он называется <code class="docutils literal notranslate"><span class="pre">DBSCAN</span></code>. Он, в свою очередь, требует как минимум задать размер шара, попадая в который соседние для выбранной точки считаются попадающими в одну группу.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Все что для выбранной точки попало в шар - считается одной группой&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="s2">&quot;Выбранная точка&quot;</span><span class="p">,</span>
    <span class="n">X</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;arrowstyle&quot;</span><span class="p">:</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_45_0.png" src="_images/day_3_45_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">DBSCAN</span>

<span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">whole_X</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Здесь еще более сложный паттерн</span><span class="se">\n</span><span class="s2">кластеров: </span><span class="si">%d</span><span class="s2">, метрика силуэта </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span><span class="p">)),</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">whole_X</span><span class="p">,</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
<span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_46_0.png" src="_images/day_3_46_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dbscan</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">whole_X</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Здесь радиус вдвое больше</span><span class="se">\n</span><span class="s2">кластеров: </span><span class="si">%d</span><span class="s2">, метрика силуэта </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span><span class="p">)),</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">whole_X</span><span class="p">,</span> <span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
<span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">dbscan</span><span class="o">.</span><span class="n">labels_</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_47_0.png" src="_images/day_3_47_0.png" />
</div>
</div>
<div class="section" id="id8">
<h3>В качестве заключения<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>Что может кластеризация? <strong>Разбить на группы? Не только это</strong>. После разбиения на группы с помощью анализа признаков можно добиться очень содержательных выводов. Так, рассмотрев более пристально что попадает в каждую группу (какие значения признаков), можно узнать о процессе гораздо больше, чем просто глядя на сырые данные. И получить ответы на поставленные вопросы.</p>
</div>
</div>
<div class="section" id="id9">
<h2>3.4 Поиск аномалий в данных<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>Поиск аномалий - тоже задача обучения без учителя, то есть что именно является аномалией - неизвестно, разметки нет. Однако аномалии - это данные, которые сильно отличаются от остальных, и это достаточно частая задача в аналитике.</p>
<p>Например, поиск странных финансовых транзакций в банках. Мы же для примера поищем “аномальные ракушки”. И первое что мы попробуем - это искать их с помощью деревьев.</p>
<p>Алгоритм <code class="docutils literal notranslate"><span class="pre">IsolationForest</span></code> использует множество деревьев, каждое из которых по выбранному признаку (с помощью случайных разбиений данных при обучении) выдает решение - является пример аномалией (<em>outlier</em>) или нет (<em>inlier</em>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># считаем наши данные и выберем пару колонок сразу</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/abalone.csv&#39;</span><span class="p">)[</span>
    <span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span>
<span class="p">]</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">IsolationForest</span>
<span class="n">isolation</span> <span class="o">=</span> <span class="n">IsolationForest</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="c1"># количество деревьев</span>
    <span class="n">contamination</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># предварительный процент аномалий</span>
<span class="p">)</span>

<span class="n">isolation</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IsolationForest(contamination=0.1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_boundaries_IF</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">draw_columns</span><span class="p">):</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Где темнее - там скорее аномалии&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues_r</span><span class="p">)</span>
    
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="n">predictions</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="n">inliers</span> <span class="o">=</span> <span class="n">predictions</span> <span class="o">&gt;</span> <span class="mi">0</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">inliers</span><span class="p">],</span>
        <span class="n">data</span><span class="p">[</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">inliers</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>
    <span class="p">);</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">outliers</span><span class="p">],</span>
        <span class="n">data</span><span class="p">[</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">outliers</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span>
    <span class="p">);</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">draw_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    
<span class="n">plot_boundaries_IF</span><span class="p">(</span><span class="n">isolation</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_51_0.png" src="_images/day_3_51_0.png" />
</div>
</div>
<p>Как мы знаем, деревья действуют по осям, разбивая данные на части больше-меньше порога. Чем больше деревьев - тем сглаженней картина. Сейчас же мы посмотрим как работает метод <code class="docutils literal notranslate"><span class="pre">Local</span> <span class="pre">Outlier</span> <span class="pre">Factor</span></code> (<em>LOF</em>).</p>
<p>Он в каждой точке оценивает плотность относительно других точек (с помощью близости). Чем ниже эта плотность - тем аномальнее пример. Он позволяет (<code class="docutils literal notranslate"><span class="pre">novelty</span> <span class="pre">=</span> <span class="pre">True</span></code>) оценивать, из того же распределения новые данные (<em>inlier</em>) или нет (<em>outlier</em>), при этом считается что тренировочные данные - без выбросов!</p>
<blockquote>
<div><p>Следовательно, <strong>LOF с novelty=True нужно применять только к новым данным, <em>не к тренировочным</em></strong> (тем более что метод базируется на ближайших соседях). Тогда он будет определять выбросы в новых данных.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">LocalOutlierFactor</span>

<span class="n">train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="c1"># половину как тренировочные данные</span>

<span class="n">indices</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))),</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">train</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="n">train</span><span class="p">:]</span>

<span class="n">isolator</span> <span class="o">=</span> <span class="n">IsolationForest</span><span class="p">(</span>
    <span class="mi">100</span><span class="p">,</span> <span class="n">contamination</span><span class="o">=</span><span class="mf">0.1</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_indices</span><span class="p">])</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="n">isolator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_indices</span><span class="p">])</span>
<span class="n">outliers</span> <span class="o">=</span> <span class="n">predicted</span> <span class="o">&lt;</span> <span class="mi">0</span>
<span class="n">inliers</span> <span class="o">=</span> <span class="n">predicted</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="n">lof</span> <span class="o">=</span> <span class="n">LocalOutlierFactor</span><span class="p">(</span>
    <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">contamination</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="c1"># в десять раз меньше</span>
    <span class="n">novelty</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_indices</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">inliers</span><span class="p">])</span>

<span class="c1"># отрисуем границу принятия решений</span>

<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">lof</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Где темнее - там скорее аномалии</span><span class="se">\n</span><span class="s2">Красным - примеры выбросов&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues_r</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_indices</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">outliers</span><span class="p">],</span>
    <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_indices</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">outliers</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Выбросы Isolation Forest&quot;</span>
<span class="p">);</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="n">lof</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_indices</span><span class="p">])</span>
<span class="n">outliers</span> <span class="o">=</span> <span class="n">predicted</span> <span class="o">&lt;</span> <span class="mi">0</span>
<span class="n">inliers</span> <span class="o">=</span> <span class="n">predicted</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_indices</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">inliers</span><span class="p">],</span>
    <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_indices</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">inliers</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Хорошие точки&quot;</span>
<span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_indices</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">outliers</span><span class="p">],</span>
    <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_indices</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">outliers</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Выбросы LOF&quot;</span>
<span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_53_0.png" src="_images/day_3_53_0.png" />
</div>
</div>
<div class="section" id="id10">
<h3>Заключение<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Анализ аномалий - это не просто найти аномальные точки. Следует исследовать, чем всё же эти точки аномальны.</p>
<p>Можно ли использовать анализ аномалий для чистки данных? Всё что не запрещено - то разрешено. Только учтите, что вы должны продумать что делать, если новая точка при предсказании - аномальна.</p>
</div>
</div>
<div class="section" id="id11">
<h2>3.5 Одномерные временные ряды<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p>Временные ряды - это последовательные данные, в которых <strong>порядок важен</strong>. Перемешивать их вредно. Рассмотрим датасет <em>airpassengers</em> (авиапассажиров), который мы уже рассматривали ранее.</p>
<p>Это одномерный временной ряд - это значит у нас есть только одна последовательность (один признак).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">airpassengers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/airpassengers.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;#Passengers&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">airpassengers</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_56_0.png" src="_images/day_3_56_0.png" />
</div>
</div>
<p>Одномерные временные ряды можно декомпозировать на</p>
<ul class="simple">
<li><p>тренд (направление),</p></li>
<li><p>сезонности (повторяющиеся компоненты),</p></li>
<li><p>праздники (пики в праздничные дни),</p></li>
<li><p>добавлять регрессоры (ряды перестают быть одномерными :)).</p></li>
</ul>
<p><strong>Основное правило с одномерными рядами такое</strong> - если вы можете продолжить его визуально, то скорее всего сможете и с помощью машинного обучения. Иначе практически бесполезно.</p>
<p>Рассмотрим модель <code class="docutils literal notranslate"><span class="pre">Prophet</span></code> из библиотеки <code class="docutils literal notranslate"><span class="pre">fbprophet</span></code>. Она поступает с временным рядом именно так, как выше, то есть декомпозирует его на тренд и на одну и более сезонности (если надо, можно учитывать праздники). Еще в неё можно передавать влияющие переменные (регрессоры), но мы не будем.</p>
<p><code class="docutils literal notranslate"><span class="pre">y(time)</span> <span class="pre">=</span> <span class="pre">trend(time)</span> <span class="pre">+</span> <span class="pre">seasonality(time)</span> <span class="pre">+</span> <span class="pre">holidays(time)</span> <span class="pre">[</span> <span class="pre">+</span> <span class="pre">regressors(time)]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fbprophet</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">fbprophet</span><span class="o">.</span><span class="n">Prophet</span><span class="p">(</span>
    <span class="n">daily_seasonality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># без внутридневной сезонности</span>
    <span class="n">weekly_seasonality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># и без недельной</span>
    <span class="n">yearly_seasonality</span><span class="o">=</span><span class="mi">7</span> <span class="c1"># количество &quot;изгибов&quot; в сезонности</span>
<span class="p">)</span>

<span class="n">train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span> <span class="c1"># длина тренировочных данных</span>

<span class="c1"># для fbprophet необходимо передавать колонки с заданными именами</span>

<span class="n">traininig_data</span> <span class="o">=</span> <span class="n">airpassengers</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span>
    <span class="s1">&#39;Month&#39;</span><span class="p">:</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;#Passengers&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span>
<span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)[:</span><span class="n">train</span><span class="p">]</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">traininig_data</span><span class="p">)</span>

<span class="n">future</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span>
    <span class="mi">12</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">)</span> <span class="o">-</span> <span class="n">train</span><span class="p">,</span> <span class="c1"># сколько точек наперёд</span>
    <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span> <span class="c1"># шагаем по началу месяца (Month Start)</span>
<span class="p">)</span>

<span class="n">forecast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<span class="n">forecast</span><span class="p">[[</span>
    <span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;yhat&#39;</span>
<span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ds</th>
      <th>trend</th>
      <th>yhat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>151</th>
      <td>1961-08-01</td>
      <td>512.574289</td>
      <td>562.072396</td>
    </tr>
    <tr>
      <th>152</th>
      <td>1961-09-01</td>
      <td>515.728581</td>
      <td>529.287096</td>
    </tr>
    <tr>
      <th>153</th>
      <td>1961-10-01</td>
      <td>518.781121</td>
      <td>499.154882</td>
    </tr>
    <tr>
      <th>154</th>
      <td>1961-11-01</td>
      <td>521.935412</td>
      <td>473.169651</td>
    </tr>
    <tr>
      <th>155</th>
      <td>1961-12-01</td>
      <td>524.987953</td>
      <td>499.495222</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Аддитивный прогноз с помощью prophet</span><span class="se">\n</span><span class="s2">качество на отложенных </span><span class="si">%d</span><span class="s2"> точках R2: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">)</span> <span class="o">-</span> <span class="n">train</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">airpassengers</span><span class="p">[</span><span class="s1">&#39;#Passengers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">train</span><span class="p">:],</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">forecast</span><span class="o">.</span><span class="n">yhat</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">train</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">)]</span>
    <span class="p">)</span>
<span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;#Passengers&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">airpassengers</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Оригинальные данные&quot;</span><span class="p">);</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;yhat&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">forecast</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Прогнозные данные&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">airpassengers</span><span class="o">.</span><span class="n">Month</span><span class="p">[</span><span class="n">train</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Окончание train&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_60_0.png" src="_images/day_3_60_0.png" />
</div>
</div>
<p>Как видим, получилось не очень хорошо. Аддитивная модель - это когда компоненты складываются - не уловила в данных той сути, что сезонность увеличивается. Заменим её на мультипликативную - одним параметром.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">fbprophet</span><span class="o">.</span><span class="n">Prophet</span><span class="p">(</span>
    <span class="n">daily_seasonality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># без внутридневной сезонности</span>
    <span class="n">weekly_seasonality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># и без недельной</span>
    <span class="n">yearly_seasonality</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="c1"># количество &quot;изгибов&quot; в сезонности</span>
    <span class="n">seasonality_mode</span><span class="o">=</span><span class="s1">&#39;multiplicative&#39;</span>
<span class="p">)</span>

<span class="n">train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span> <span class="c1"># длина тренировочных данных</span>

<span class="c1"># для fbprophet необходимо передавать колонки с заданными именами</span>

<span class="n">traininig_data</span> <span class="o">=</span> <span class="n">airpassengers</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span>
    <span class="s1">&#39;Month&#39;</span><span class="p">:</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;#Passengers&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span>
<span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)[:</span><span class="n">train</span><span class="p">]</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">traininig_data</span><span class="p">)</span>

<span class="n">future</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span>
    <span class="mi">12</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">)</span> <span class="o">-</span> <span class="n">train</span><span class="p">,</span> <span class="c1"># сколько точек наперёд</span>
    <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span> <span class="c1"># шагаем по началу месяца (Month Start)</span>
<span class="p">)</span>

<span class="n">forecast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Мультипликативный прогноз с помощью prophet</span><span class="se">\n</span><span class="s2">качество на отложенных </span><span class="si">%d</span><span class="s2"> точках R2: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">)</span> <span class="o">-</span> <span class="n">train</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">airpassengers</span><span class="p">[</span><span class="s1">&#39;#Passengers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">train</span><span class="p">:],</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">forecast</span><span class="o">.</span><span class="n">yhat</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">train</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">)]</span>
    <span class="p">)</span>
<span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;#Passengers&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">airpassengers</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Оригинальные данные&quot;</span><span class="p">);</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;yhat&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">forecast</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Прогнозные данные&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">airpassengers</span><span class="o">.</span><span class="n">Month</span><span class="p">[</span><span class="n">train</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Окончание train&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_62_0.png" src="_images/day_3_62_0.png" />
</div>
</div>
<p>Почему модель с умножением получилась лучше? Потому что чтобы сделать аддитивную модель мультипликативной, достаточно преобразовать целевую величину, например через логарифмирование. Посмотрим.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">airpassengers</span><span class="o">.</span><span class="n">Month</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">[</span><span class="s2">&quot;#Passengers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Исходные данные&quot;</span>
<span class="p">);</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">airpassengers</span><span class="o">.</span><span class="n">Month</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">airpassengers</span><span class="p">[</span><span class="s2">&quot;#Passengers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Логарифмированные данные&quot;</span>
<span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_64_0.png" src="_images/day_3_64_0.png" />
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">fbprophet</span></code> имеет также полезные функции и для отладки.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">plot_components</span><span class="p">(</span><span class="n">forecast</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_66_0.png" src="_images/day_3_66_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_67_0.png" src="_images/day_3_67_0.png" />
</div>
</div>
<p>Вот так вот всё, можно спросить?</p>
<div class="section" id="id12">
<h3>Заключение<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>Нет. Это достаточно простой ряд. <code class="docutils literal notranslate"><span class="pre">fbprophet</span></code> имеет большое количество настроек сам по себе. Более того, для временных рядов следует отбирать модель немного другим механизмом кросс-валидации:</p>
<ul class="simple">
<li><p>сначала откладывается тренировочное множество,</p></li>
<li><p>на нем тренируется модель, качество измеряется на отложенном хвосте,</p></li>
<li><p>далее в тренировочное множество добавляются следующие точки (одна или несколько подряд),</p></li>
<li><p>снова измеряется качество…</p></li>
<li><p>и так нужно делать столько раз, сколько у вас сочетаний параметров.</p></li>
</ul>
<p>Сами по себе одномерные временные ряды редко встречаются в ~~дикой~~ природе. Тем не менее они полезны, когда у вас есть много временных признаков и вам хочется пустить их наперед для предсказания некоторой величины (например уровня инфляции от изменения ВВП и численности населения). В этом случае используется <em><strong>стэкинг</strong></em>, и важно делать его правильно.</p>
</div>
</div>
<div class="section" id="id13">
<h2>3.6 Стэкинг, или объединение нескольких моделей<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<p>Главное правило стэкинга - вы должны <strong>обучать вторую модель на тех предсказаниях, которые были получены НЕ с тренировочного множества</strong> первой модели. То есть (почти) как кросс-валидация - нельзя учить на тех же данных, про которые уже что-то известно.</p>
<p>Иначе вы получите “протечку” в данных, а на выходе - переобученную модель. Она будет очень много (очень) знать про своё тренировочное множество, но не будет хорошо генерализовать искомую зависимость в данных. То есть тренировочных множества должно быть как минимум два.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/abalone.csv&#39;</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;rings&#39;</span>
<span class="n">features</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;sex&#39;</span><span class="p">)</span>
<span class="n">features</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">train_base_X</span><span class="p">,</span> <span class="n">test_base_X</span><span class="p">,</span> <span class="n">train_base_y</span><span class="p">,</span> <span class="n">test_base_y</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">train_stack_X</span><span class="p">,</span> <span class="n">test_stack_X</span><span class="p">,</span> <span class="n">train_stack_y</span><span class="p">,</span> <span class="n">test_stack_y</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">test_base_X</span><span class="p">,</span> <span class="n">test_base_y</span><span class="p">,</span>
    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">train_base_X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">train_stack_X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">test_stack_X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> \
<span class="n">train_base_y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">train_stack_y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">test_stack_y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((2088, 7), (1044, 7), (1045, 7), (2088, 1), (1044, 1), (1045, 1))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>

<span class="n">base_estimator</span> <span class="o">=</span> <span class="n">MLPRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_base_X</span><span class="p">,</span> <span class="n">train_base_y</span><span class="p">)</span>

<span class="n">stack_estimator</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
        <span class="n">train_stack_X</span><span class="p">,</span>
        <span class="n">base_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_stack_X</span><span class="p">)</span>
    <span class="p">]),</span>
    <span class="n">train_stack_y</span>
<span class="p">)</span>

<span class="s2">&quot;R2 stacked </span><span class="si">%.3f</span><span class="s2">, R2 base </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r2_score</span><span class="p">(</span>
    <span class="n">test_stack_y</span><span class="p">,</span>
    <span class="n">stack_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
            <span class="n">test_stack_X</span><span class="p">,</span>
            <span class="n">base_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_stack_X</span><span class="p">)</span>
        <span class="p">])</span>
    <span class="p">)</span>
<span class="p">),</span> <span class="n">r2_score</span><span class="p">(</span>
    <span class="n">test_stack_y</span><span class="p">,</span>
    <span class="n">base_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_stack_X</span><span class="p">)</span>
<span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;R2 stacked 0.547, R2 base 0.513&#39;
</pre></div>
</div>
</div>
</div>
<p>Как видим, в данном случае стэкинг улучшил результат. Но это бывает далеко не всегда так. И увлекаться им надо только с пониманием его цели. Мало того что неудобно бить датасет на многие части, так еще мы уменьшаем количество размеченных данных в случае стэкинга (а они у нас на вес золота).</p>
<p>К счастью в <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> есть классы <code class="docutils literal notranslate"><span class="pre">StackingRegressor</span></code> и <code class="docutils literal notranslate"><span class="pre">StackingClassifier</span></code>, которые производят обучают последовательность моделей на всех данных, кроме последней модели, для которой они проводят уже обучение на разбиениях.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">StackingRegressor</span>

<span class="n">regressor</span> <span class="o">=</span> <span class="n">StackingRegressor</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;MLP&#39;</span><span class="p">,</span> <span class="n">MLPRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;GBR&#39;</span><span class="p">,</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="p">])</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">([</span>
        <span class="n">train_base_X</span><span class="p">,</span> <span class="n">train_stack_X</span>
    <span class="p">]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">([</span>
        <span class="n">train_base_y</span><span class="p">,</span> <span class="n">train_stack_y</span>
    <span class="p">])</span>
<span class="p">)</span>

<span class="s2">&quot;R2 </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
    <span class="n">test_stack_X</span><span class="p">,</span>
    <span class="n">test_stack_y</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;R2 0.545&#39;
</pre></div>
</div>
</div>
</div>
<p>С учетом кросс-валидации - практически то же самое.</p>
<p>Посмотрим, как можно использовать стэкинг для временных рядов. Для этого возьмем датасет <em>jena_climate</em> - датасет замера погодных характеристик около института (биогеохимии) Макса Планка в местечке <em>Jena</em> (Йена, Германия).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">climate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/jena_climate_2009_2016.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date Time&#39;</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">climate</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 420551 entries, 0 to 420550
Data columns (total 15 columns):
Date Time          420551 non-null datetime64[ns]
p (mbar)           420551 non-null float64
T (degC)           420551 non-null float64
Tpot (K)           420551 non-null float64
Tdew (degC)        420551 non-null float64
rh (%)             420551 non-null float64
VPmax (mbar)       420551 non-null float64
VPact (mbar)       420551 non-null float64
VPdef (mbar)       420551 non-null float64
sh (g/kg)          420551 non-null float64
H2OC (mmol/mol)    420551 non-null float64
rho (g/m**3)       420551 non-null float64
wv (m/s)           420551 non-null float64
max. wv (m/s)      420551 non-null float64
wd (deg)           420551 non-null float64
dtypes: datetime64[ns](1), float64(14)
memory usage: 48.1 MB
</pre></div>
</div>
</div>
</div>
<p>Достаточно большой датасет. Мы выберем за целевую величину температуру в градусах, а за признаки - давление, влажность в процентах, скорость ветра в м/с и направление в градусах.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;p (mbar)&#39;</span><span class="p">,</span> <span class="s1">&#39;rh (%)&#39;</span><span class="p">,</span> <span class="s1">&#39;wv (m/s)&#39;</span><span class="p">,</span> <span class="s1">&#39;wd (deg)&#39;</span><span class="p">,</span> <span class="s1">&#39;Date Time&#39;</span><span class="p">]</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;T (degC)&#39;</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Date Time&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">climate</span><span class="p">[:</span><span class="mi">20</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_77_0.png" src="_images/day_3_77_0.png" />
</div>
</div>
<p>Нас не будут интересовать все 420 тысяч записей (каждые 10 минут), а только дневные, поэтому мы переиндексируем таблицу в среднедневные значения.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">climate</span><span class="p">[</span><span class="n">features</span> <span class="o">+</span> <span class="p">[</span><span class="n">target</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date Time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>p (mbar)</th>
      <th>rh (%)</th>
      <th>wv (m/s)</th>
      <th>wd (deg)</th>
      <th>T (degC)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>2921.000000</td>
      <td>2921.000000</td>
      <td>2921.000000</td>
      <td>2921.000000</td>
      <td>2921.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>989.220852</td>
      <td>76.031012</td>
      <td>1.700779</td>
      <td>174.772827</td>
      <td>9.438993</td>
    </tr>
    <tr>
      <th>std</th>
      <td>8.095683</td>
      <td>11.377820</td>
      <td>23.155030</td>
      <td>54.411625</td>
      <td>7.840078</td>
    </tr>
    <tr>
      <th>min</th>
      <td>948.995972</td>
      <td>37.580347</td>
      <td>-1248.217847</td>
      <td>0.000000</td>
      <td>-16.457292</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>984.359861</td>
      <td>67.685764</td>
      <td>1.448542</td>
      <td>142.243611</td>
      <td>3.808333</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>989.530000</td>
      <td>76.988472</td>
      <td>1.903194</td>
      <td>188.648264</td>
      <td>9.708333</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>994.432917</td>
      <td>84.561319</td>
      <td>2.586806</td>
      <td>212.555000</td>
      <td>15.444722</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1013.957569</td>
      <td>100.000000</td>
      <td>7.644514</td>
      <td>279.445139</td>
      <td>29.375347</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataset</span><span class="p">[:</span><span class="mi">365</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_80_0.png" src="_images/day_3_80_0.png" />
</div>
</div>
<p>Пока не очень верится, связаны ли признаки.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># удалим пропуски, вдруг они есть</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">365</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_83_0.png" src="_images/day_3_83_0.png" />
</div>
</div>
<p>Выглядит очень “рваненько”. Разгладим значения <em>скользящим средним</em>. Скользящее среднее - это усреднее за некоторый период (окно), и в каждой точке для усреднения используются соседние значения (от текущей до минус размер окна пополам, до текущей плюс размер окна пополам).</p>
<p>Давайте сравним.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">][:</span><span class="mi">365</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[:</span><span class="mi">365</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Filtered&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_85_0.png" src="_images/day_3_85_0.png" />
</div>
</div>
<p>Мы потеряли некоторую информацию о погодных аномалиях, но в среднем не сильно большие отличия.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># применим ко всем данным и стандартизируем данные</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">mean</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>

<span class="n">mean</span><span class="p">,</span> <span class="n">std</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(p (mbar)    989.146469
 rh (%)       75.981322
 wv (m/s)      1.701231
 wd (deg)    174.699809
 T (degC)      9.518540
 dtype: float64, p (mbar)     4.289267
 rh (%)       7.876976
 wv (m/s)     5.197971
 wd (deg)    23.847316
 T (degC)     7.043358
 dtype: float64)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_train_test_features</span><span class="p">(</span><span class="n">train_size</span><span class="p">,</span> <span class="n">forecast_steps</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">features_without_date</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">features_without_date</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">)</span>    
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features_without_date</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">fbprophet</span><span class="o">.</span><span class="n">Prophet</span><span class="p">(</span>
            <span class="n">daily_seasonality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">weekly_seasonality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">yearly_seasonality</span><span class="o">=</span><span class="mi">365</span> <span class="o">//</span> <span class="mi">10</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[[</span><span class="n">feature</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span>
                <span class="s1">&#39;Date Time&#39;</span><span class="p">:</span> <span class="s1">&#39;ds&#39;</span><span class="p">,</span>
                <span class="n">feature</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span>
            <span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)[:</span><span class="n">train_size</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="n">future</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span>
            <span class="n">forecast_steps</span><span class="p">,</span> <span class="n">include_history</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="n">result</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span><span class="o">.</span><span class="n">yhat</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">features_train</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">180</span>
<span class="n">future_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">features_train</span> <span class="o">+</span> <span class="mi">365</span>

<span class="n">features_forecast</span> <span class="o">=</span> <span class="n">get_train_test_features</span><span class="p">(</span>
    <span class="n">train_size</span><span class="o">=</span><span class="n">features_train</span><span class="p">,</span>
    <span class="n">forecast_steps</span><span class="o">=</span><span class="n">future_steps</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">features_forecast</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">features_train</span><span class="p">],</span> <span class="n">periods</span><span class="o">=</span><span class="n">future_steps</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">future_steps</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">features_train</span> <span class="o">-</span> <span class="n">train</span>

<span class="c1"># поскольку у нас здесь обычная регрессия, мы можем примеры перемешать</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span>
    <span class="n">features_data</span><span class="p">[:</span><span class="n">train</span><span class="p">],</span>
    <span class="n">data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">features_train</span><span class="p">:</span><span class="n">features_train</span> <span class="o">+</span> <span class="n">train</span><span class="p">],</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span><span class="p">,</span> <span class="n">PowerTransformer</span>

<span class="n">target_regressor</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">PowerTransformer</span><span class="p">(),</span>
    <span class="n">LinearRegression</span><span class="p">()</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="s2">&quot;R2 test (</span><span class="si">%d</span><span class="s2"> samples) </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">target_regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
    <span class="n">features_data</span><span class="p">[</span><span class="n">train</span><span class="p">:</span><span class="n">train</span> <span class="o">+</span> <span class="n">test</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
        <span class="n">features_train</span> <span class="o">+</span> <span class="n">train</span><span class="p">:</span><span class="n">features_train</span> <span class="o">+</span> <span class="n">train</span> <span class="o">+</span> <span class="n">test</span>
    <span class="p">]</span>
<span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;R2 test (631 samples) 0.733&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>

<span class="n">t_original</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
    <span class="n">features_train</span> <span class="o">+</span> <span class="n">train</span><span class="p">:</span><span class="n">features_train</span> <span class="o">+</span> <span class="n">train</span> <span class="o">+</span> <span class="n">test</span>
<span class="p">]</span>

<span class="n">t_predicted</span> <span class="o">=</span> <span class="n">target_regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features_data</span><span class="p">[</span><span class="n">train</span><span class="p">:])</span> <span class="o">*</span> <span class="n">std</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">+</span> <span class="n">mean</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Как выглядит предсказание, средняя ошибка в градусах </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mean_absolute_error</span><span class="p">(</span>
    <span class="n">t_original</span><span class="p">,</span>
    <span class="n">t_predicted</span><span class="p">[:</span><span class="n">test</span><span class="p">]</span>
<span class="p">));</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">features_data</span><span class="p">[</span><span class="n">train</span><span class="p">:</span><span class="n">train</span> <span class="o">+</span> <span class="n">test</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
        <span class="n">features_train</span> <span class="o">+</span> <span class="n">train</span><span class="p">:</span><span class="n">features_train</span> <span class="o">+</span> <span class="n">train</span> <span class="o">+</span> <span class="n">test</span>
    <span class="p">]</span> <span class="o">*</span> <span class="n">std</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">+</span> <span class="n">mean</span><span class="p">[</span><span class="n">target</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Скользящая 31-дневная средняя TRUE DATA&quot;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span>
<span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">features_data</span><span class="p">[</span><span class="n">train</span><span class="p">:</span><span class="n">train</span> <span class="o">+</span> <span class="n">test</span> <span class="o">+</span> <span class="mi">365</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
    <span class="n">t_predicted</span><span class="p">[:</span><span class="n">test</span> <span class="o">+</span> <span class="mi">365</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PRED DATA&#39;</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span>
<span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">features_data</span><span class="p">[</span><span class="n">train</span><span class="p">:</span><span class="n">train</span> <span class="o">+</span> <span class="n">test</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">t_original</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;TRUE DATA&#39;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span>
<span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_3_90_0.png" src="_images/day_3_90_0.png" />
</div>
</div>
<p>Как видим, со средней точностью до 4 градусов - температуру предсказывать можно хоть на пару лет вперёд :)</p>
<div class="section" id="id14">
<h3>Заключение<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>Правильный стэкинг - сложная вещь, и использовать его без крайней на то необходимости лишнее.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "py35"
        },
        kernelOptions: {
            kernelName: "py35",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'py35'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="day_2.html" title="previous page">День второй - анализ данных</a>
    <a class='right-next' id="next-link" href="day_4.html" title="next page">День четвертый - нейросети (изображения, тексты, многомерные ряды)</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Sazonov Andrey<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="_static/js/index.js"></script>
    
  </body>
</html>