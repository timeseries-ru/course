

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>День четвертый - нейросети (изображения, тексты, многомерные ряды) &#8212; ML introduction</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-dropdown.css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="День пятый - интерпретация, внедрение и другие темы" href="day_5.html" />
    <link rel="prev" title="День третий - обучение без учителя*" href="day_3.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  
  <h1 class="site-logo" id="site-title">ML introduction</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="README.html">
   Курс “Введение в анализ данных и машинное обучение”
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="day_1.html">
   День первый, обзорный
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="day_2.html">
   День второй - анализ данных
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="day_3.html">
   День третий - обучение без учителя*
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   День четвертый - нейросети (изображения, тексты, многомерные ряды)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="day_5.html">
   День пятый - интерпретация, внедрение и другие темы
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cheatsheet.html">
   Как делать проекты
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="maths_behind.html">
   Визуально о математике, стоящей за некоторыми алгоритмами
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="recipes_book.html">
   Сборник полезных рецептов
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="self_check.html">
   Вопросы для самопроверки
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/day_4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/day_4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/executablebooks/jupyter-book/blob/master/day_4.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#keras">
   4.1 Нейронные сети на
   <code class="docutils literal notranslate">
    <span class="pre">
     keras
    </span>
   </code>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Заключение
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   4.2 Автоэнкодеры
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Заключение
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id5">
   4.3 Классификация и сегментация изображений
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Заключение
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id7">
   4.4 Готовые нейросети для работы с изображениями
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Заключение
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id9">
   4.5 Тексты и нейросети
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     Заключение
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id11">
   4.6 Рекуррентные нейросети для временных рядов
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id12">
     Заключение
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="id1">
<h1>День четвертый - нейросети (изображения, тексты, многомерные ряды)<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>Программа дня:</p>
<ul class="simple">
<li><p>нейронные сети с помощью библиотеки <code class="docutils literal notranslate"><span class="pre">keras</span></code>, устройство нейросетей,</p></li>
<li><p>сети, которые выдают свой вход и зачем они нужны - автоэнкодеры,</p></li>
<li><p>элементы работы с изображениями: классификация, сегментация</p></li>
<li><p>предобученные сети работы с изображениями,</p></li>
<li><p>тексты: кодирование, поиск “по смыслу”, извлечение сущностей, суммаризация,</p></li>
<li><p>многомерные временные ряды (и рекуррентные нейронные сети).</p></li>
</ul>
<div class="section" id="keras">
<h2>4.1 Нейронные сети на <code class="docutils literal notranslate"><span class="pre">keras</span></code><a class="headerlink" href="#keras" title="Permalink to this headline">¶</a></h2>
<p>В конце второго дня мы рассмотрели некоторый пример нейронных сетей. Все слои там были одинаковые по устройству, и каждый нейрон слоя был связан с каждым нейроном следующего. Такие сети и слои называют <em>полносвязными</em> (<em>Dense</em>), и это только один из типов слоёв. Ввиду количества связей, полносвязные сети содержат просто огромное количество параметров, из-за этого они долго учатся и дают не самую минимальную ошибку (на не очень большом количестве данных).</p>
<p>Помните, для градиентного спуска мы искали производную по каждому параметру? То же делает и библиотека <code class="docutils literal notranslate"><span class="pre">tensorflow</span></code> (от Google), только она дифференцирует по параметрам автоматически вместо нас (благодаря особой математике на графах операций). <code class="docutils literal notranslate"><span class="pre">keras</span></code> - это надстройка над библиотекой <code class="docutils literal notranslate"><span class="pre">tensorflow</span></code>, позволяющая конструировать различные нейросети, и искать с заданной функцией ошибки её минимум.</p>
<p>Библиотека <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> в отличие от <code class="docutils literal notranslate"><span class="pre">keras</span></code>, работает только с полносвязными сетями, и не позволяет произвольно настраивать эту функцию ошибки. <strong>Функция ошибки является спецификацией задачи нейросети</strong> - это означает что архитектурно одна и та же сеть может может подстраивать свои параметры под разные задачи.</p>
<p>Помимо упомянутого <code class="docutils literal notranslate"><span class="pre">Dense</span></code>-слоя, существуют следующие слои:</p>
<ol class="simple">
<li><p>Свёрточные (<code class="docutils literal notranslate"><span class="pre">Convolution</span></code>) - применяются обычно для обработки изображений. Они пробегают некоторым окном по всем входным признакам, и вычисляют <em>свертку</em> - некоторую функцию с весами сразу над несколькими признаками. Это мало того что позволяет сократить количество весов, но и конструировать новые (внутри сети) признаки.</p></li>
<li><p>Pooling (<code class="docutils literal notranslate"><span class="pre">Pooling</span></code>, субдискретизация, обычно не переводят) - применение операции усреднения или взятия максимума над входными в слой признаками, также пробегая по данным некоторым окном. Используются для снижения размерности сети и извлечения полезных признаков.</p></li>
<li><p>Рекуррентные (<code class="docutils literal notranslate"><span class="pre">Recurrent</span></code>) - применяются для работы с последовательностями (тексты, временные ряды). Таким слоям на вход подаются последовательности, а они подстраивают свои веса с учетом структуры (если она есть конечно) последовательности.</p></li>
<li><p>Dropout (<code class="docutils literal notranslate"><span class="pre">Dropout</span></code>, выбрасывание, обычно не переводят) - это особый слой, который… выбрасывает случайно заданный процент нейронов между слоями. Это позволяет <em>регуляризовывать</em> сеть (избегать переобучения), а так же делает все нейроны сети более “осведомленными”, скажем так.</p></li>
<li><p>Слои вложений (<code class="docutils literal notranslate"><span class="pre">Embeddings</span></code>) - полезны для работы с категориальными данными. Это так же и тексты (со словами из словаря). Такие слои представляют собой таблицу весов, которые переводят входные категории в вектора заданной размерности.</p></li>
</ol>
<p>Слои могут (и должны) использовать функцию активации: после умножения весов на вход и сложения, для нейрона полносвязного слоя например, она применяется к результату, чтобы не получить комбинацию линейных моделей (а получить комбинацию нелинейных). Комбинация линейных моделей - линейная модель. Мы уже рассматривали во втором дне <code class="docutils literal notranslate"><span class="pre">relu</span></code>, <code class="docutils literal notranslate"><span class="pre">tanh</span></code>, <code class="docutils literal notranslate"><span class="pre">sigmoid</span></code> (<code class="docutils literal notranslate"><span class="pre">logistic</span></code> в <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>).</p>
<p>Как видим, различные слои подходят под различные задачи.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># будем учить сети на CPU</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-1&#39;</span> <span class="c1"># 0 для GPU</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">tensorflow.keras</span> <span class="k">as</span> <span class="nn">keras</span>
<span class="n">keras</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;2.3.0-tf&#39;
</pre></div>
</div>
</div>
</div>
<p>Рассмотрим теперь новый датасет - Forest Cover Types - покрытие лесов. Он содержит 54 признака лесного покрытия, и метку - один из 7 типов леса. Всего в нём 581 012 записей, каждая из которых имеет свой класс (лесного покрытия). Среди признаков: тип почвы, высота над уровнем моря, и другие подобные признаки.</p>
<p><img alt="Forest" src="_images/forest_covtypes.jpg" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_covtype</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">fetch_covtype</span><span class="p">(</span><span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))),</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">train</span><span class="p">]</span>
<span class="n">test_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">train</span><span class="p">:]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Размер всех данных </span><span class="si">%d</span><span class="s2">, тренировочных </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Размер всех данных 581012, тренировочных 464809
</pre></div>
</div>
</div>
</div>
<p>Раз у нас задача классификации, и классов более двух, наша сеть нам должна отдавать вектор (неоткалиброванных вероятностей - калибрация это отдельная история), где индекс наибольшего числа будет указывать на предсказанный класс. Делается это с помощью функции <code class="docutils literal notranslate"><span class="pre">softmax(x1,</span> <span class="pre">...,</span> <span class="pre">xk)</span> <span class="pre">=</span> <span class="pre">(exp(x1)</span> <span class="pre">/</span> <span class="pre">sum(exp(xj)),</span> <span class="pre">...,</span> <span class="pre">exp(xk)</span> <span class="pre">/</span> <span class="pre">sum(exp(xj))),</span> <span class="pre">j</span> <span class="pre">=</span> <span class="pre">1..k</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">number_features</span><span class="p">,</span> <span class="n">number_classes</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">number_features</span><span class="p">,)),</span>
        
        <span class="c1"># пятую часть нейронов при тренировке будем занулять</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        
        <span class="c1"># промежуточный слой</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
        
        <span class="c1"># выходной слой</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">number_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="c1"># мы должны специфицировать задачу сети</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">train_indices</span><span class="p">])</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">train_indices</span><span class="p">])</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">test_indices</span><span class="p">])</span>

<span class="c1"># мы должны привести наши классы к векторам вида (0, 1, 0) </span>
<span class="c1"># где 1 стоит на том месте, где должен быть нужный пол</span>
<span class="n">y_categorical</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">y_categorical</span><span class="p">[</span><span class="n">train_indices</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_categorical</span><span class="p">[</span><span class="n">test_indices</span><span class="p">]</span>

<span class="c1"># перед созданием модели сбросим</span>
<span class="c1"># уже сохраненные модели</span>
<span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span>
    <span class="n">number_features</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">number_classes</span><span class="o">=</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Что мы задали в <code class="docutils literal notranslate"><span class="pre">compile</span></code>?</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">optimizer</span></code> - это способ поиска минимума функции ошибки. Существуют различные оптимизаторы, самые используемые: <code class="docutils literal notranslate"><span class="pre">rmsprop</span></code> (обычно для рекуррентных сетей), <code class="docutils literal notranslate"><span class="pre">sgd</span></code> (когда данных очень много), <code class="docutils literal notranslate"><span class="pre">adam</span></code> (один из самых лучших). Они как раз принимают решение, насколько далеко шагать с помощью вычисленной производной ошибки,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">loss</span></code> - это как раз функция ошибки. Для бинарной классификации используют на последнем слое активацию <code class="docutils literal notranslate"><span class="pre">sigmoid</span></code> и <code class="docutils literal notranslate"><span class="pre">loss</span> <span class="pre">=</span> <span class="pre">'binary_crossentropy'</span></code>, у нас многоклассовая классификация - поэтому <code class="docutils literal notranslate"><span class="pre">'categorical_crossentropy'</span></code>. Кросс-энтропия тем ниже, чем меньше перепутаны предсказанные и истинные метки. Для регрессии же используют функции потерь <code class="docutils literal notranslate"><span class="pre">mae</span></code> (<em>mean_absolute_error</em>) или <code class="docutils literal notranslate"><span class="pre">mse</span></code> (<em>mean_squared_error</em>) - которые являются средним (абсолютным или квадратичным) отклонением предсказанного от известных значений,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metrics</span></code> - это то, что в процессе обучение будет подсчитываться просто для информации или для отбора лучшей модели. В нашем случае <code class="docutils literal notranslate"><span class="pre">accuracy</span></code> - это процент правильных ответов.</p></li>
</ul>
<p>Ну что ж, обучим нашу нейросеть. При обучении мы зададим <em>количество эпох</em> и <em>размер пакета</em> (<em>batch size</em>). Одна эпоха - это один проход по всем тренировочным данным с выборкой размера пакета (то есть шагом в размер пакета). На каждый пакет подсчитываются (те самые) производные по параметрам для каждого пакета и обновляются веса нейросети.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span> <span class="c1"># выводить информацию по ходу дела, 1 - подробнее</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.6974 - accuracy: 0.7127
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 2/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.5703 - accuracy: 0.7545
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 3/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.5339 - accuracy: 0.7693
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 4/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.5065 - accuracy: 0.7819
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 5/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.4849 - accuracy: 0.7927
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 6/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.4672 - accuracy: 0.8004
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 7/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.4533 - accuracy: 0.8076
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 8/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.4409 - accuracy: 0.8126
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 9/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.4300 - accuracy: 0.8183
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 10/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.4210 - accuracy: 0.8222
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 11/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.4145 - accuracy: 0.8252
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 12/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.4077 - accuracy: 0.8281
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 13/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.4010 - accuracy: 0.8320
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 14/30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454/454 - 2s - loss: 0.3960 - accuracy: 0.8338
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 15/30
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;loss </span><span class="si">%.2f</span><span class="s1">, accuracy </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3632/3632 [==============================] - 3s 939us/step - loss: 0.2987 - accuracy: 0.8801
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;loss 0.30, accuracy 0.88&#39;
</pre></div>
</div>
</div>
</div>
<p>Поскольку метрика качества продолжает расти, скорее всего мы задали мало итераций. Однако сети имеют свойство переобучаться, поэтому и используется и <code class="docutils literal notranslate"><span class="pre">dropout</span></code>, и отбор лучшей модели по метрикам. Для последнего, используется <code class="docutils literal notranslate"><span class="pre">callback</span></code> (функция, вызываемая на каждой эпохе) <code class="docutils literal notranslate"><span class="pre">ModelCheckpoint</span></code>. Как его использовать, наряду со своим ~~доморощенным~~, показано в коде ниже.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>

<span class="c1"># отнаследуемся от базового класса и переопределим конструктор</span>
<span class="c1"># и метод, вызываемый по окончанию эпохи</span>

<span class="k">class</span> <span class="nc">PlotLosses</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_max</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PlotLosses</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span> <span class="ow">or</span> <span class="s1">&#39;loss&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">better</span> <span class="o">=</span> <span class="nb">max</span> <span class="k">if</span> <span class="n">check_max</span> <span class="k">else</span> <span class="nb">min</span>
        
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_step</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">better</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_step</span> <span class="o">=</span> <span class="n">epoch</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#323232&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#323232&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Step </span><span class="si">%d</span><span class="s2">, </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="p">),</span>
            <span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;, validation </span><span class="si">%.4f</span><span class="s2"> (best </span><span class="si">%.4f</span><span class="s2"> at </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">better</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_step</span>
        <span class="p">)</span> <span class="k">if</span> <span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Для отбора лучшей модели используют валидационное множество (а итоговое качество всё так же проверяют на тестовом).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span>
    <span class="n">number_features</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">number_classes</span><span class="o">=</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># четверть тренировочных оставим</span>
<span class="c1"># под валидацию</span>
<span class="n">validation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">[</span><span class="n">validation</span><span class="p">:],</span> <span class="n">y_train</span><span class="p">[</span><span class="n">validation</span><span class="p">:],</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:</span><span class="n">validation</span><span class="p">],</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">validation</span><span class="p">]),</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># НЕ выводить информацию по ходу дела</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span>
        <span class="n">PlotLosses</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
            <span class="s1">&#39;models/covtypes.h5&#39;</span><span class="p">,</span>
            <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span>
            <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_13_0.png" src="_images/day_4_13_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># загрузим нашу лучшую отобранную по accuracy на валидации модель</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;models/covtypes.h5&#39;</span><span class="p">)</span>
<span class="s1">&#39;loss </span><span class="si">%.2f</span><span class="s1">, accuracy </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">best_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3632/3632 [==============================] - 4s 991us/step - loss: 0.2572 - accuracy: 0.8973
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;loss 0.26, accuracy 0.90&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="id2">
<h3>Заключение<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Видим, что метрика и дальше могла бы улучшаться, но с каждым шагом дальше это происходит всё медленнее, улучшение всё меньше. На диаграммах, подобных выше, сразу видно, переобучается модель (на тренировочных данных метрика сильно больше) или нет (тренировочные и валидационные данные дают схожие метрики).</p>
<p>Так же стоит отметить, что готовить данные для сетей и обучать их - дело не самое простое. Тем не менее, их “всеядность” в плане данных не оставляет иного выбора исследователям. И далее мы посмотрим, что еще могут такого нейросети, кроме и так нам понятных табличных данных.</p>
</div>
</div>
<div class="section" id="id3">
<h2>4.2 Автоэнкодеры<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Автоэнкодеры - это сети, которые для своих входов на выходе выдают этот же вход. Стараются по-крайней мере :) Давайте сразу начнем с примера, и примера повеселее - датасета <code class="docutils literal notranslate"><span class="pre">fashion</span> <span class="pre">mnist</span></code>, который содержит 60 тысяч тренировочных примеров, и 10 тысяч тестовых примеров изображений одежды размеров 28х28 пикселей в градациях серого (0 черный, 1 белый), разбитых по 10 классам (различные ботинки, брюки, свитера-майки).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mnist</span>
<span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">test_y</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">fashion_mnist</span><span class="p">()</span>
<span class="n">fashion</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;T-shirt/top&#39;</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Trouser&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Pullover&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;Dress&#39;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;Coat&#39;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;Sandal&#39;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;Shirt&#39;</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;Sneaker&#39;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;Bag&#39;</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;Ankle boot&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[MNIST] Caching data at C:\Users\Sazonov_AV\.local\share\FASHION_MNIST
[MNIST] Found http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-images-idx3-ubyte.gz in cache.
[MNIST] Found http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-images-idx3-ubyte.gz in cache.
[MNIST] Found http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-labels-idx1-ubyte.gz in cache.
[MNIST] Found http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-labels-idx1-ubyte.gz in cache.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">fashion</span><span class="p">[</span><span class="n">test_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_18_0.png" src="_images/day_4_18_0.png" />
</div>
</div>
<p>Построим сразу сверточную нейросеть, которая будет сворачивать изображение до вектора, а потом разворачивать в изображение обратно.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_autoencoder</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">vector_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">input_layer</span> <span class="o">=</span> <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="n">filters</span> <span class="o">=</span> <span class="mi">16</span>
    
    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    <span class="c1"># после этого у нас размерность данных 28 * 28 * filters</span>
        
    <span class="c1"># возьмем максимум из получаемых данных максимум,</span>
    <span class="c1"># padding same - означает дополнять изображение значениям краёв, когда окно выходит за его пределы</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    <span class="c1"># после этого у нас размерность 14 * 14 * filters</span>
    
    <span class="c1"># процедуру повторим</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="c1"># свернем всё в вектор</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="n">encoded</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">vector_size</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="n">encoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">encoded</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;encoder&#39;</span><span class="p">)</span>    
    
    <span class="c1"># вернем всё обратно</span>
    <span class="n">decoder_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">((</span><span class="n">vector_size</span><span class="p">,</span> <span class="p">))</span>
    
    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">filters</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">decoder_input</span><span class="p">)</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">filters</span><span class="p">))(</span><span class="n">layer</span><span class="p">)</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="c1"># реконструируем наше изображение</span>
    <span class="c1"># будем выдавать степень &quot;белизны&quot;</span>
    <span class="n">output_layer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">decoder_input</span><span class="p">,</span> <span class="n">output_layer</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;decoder&#39;</span><span class="p">)</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">decoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">(</span><span class="n">input_layer</span><span class="p">)))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span>

<span class="n">autoencoder</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span> <span class="o">=</span> <span class="n">create_autoencoder</span><span class="p">((</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># 1 - это у нас один черно-белый канал</span>
<span class="nb">print</span><span class="p">(</span><span class="n">encoder</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;encoder&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         [(None, 28, 28, 1)]       0         
_________________________________________________________________
conv2d (Conv2D)              (None, 28, 28, 16)        160       
_________________________________________________________________
max_pooling2d (MaxPooling2D) (None, 14, 14, 16)        0         
_________________________________________________________________
conv2d_1 (Conv2D)            (None, 14, 14, 16)        2320      
_________________________________________________________________
max_pooling2d_1 (MaxPooling2 (None, 7, 7, 16)          0         
_________________________________________________________________
flatten (Flatten)            (None, 784)               0         
_________________________________________________________________
dense (Dense)                (None, 3)                 2355      
=================================================================
Total params: 4,835
Trainable params: 4,835
Non-trainable params: 0
_________________________________________________________________
None
Model: &quot;decoder&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_2 (InputLayer)         [(None, 3)]               0         
_________________________________________________________________
dense_1 (Dense)              (None, 784)               3136      
_________________________________________________________________
reshape (Reshape)            (None, 7, 7, 16)          0         
_________________________________________________________________
up_sampling2d (UpSampling2D) (None, 14, 14, 16)        0         
_________________________________________________________________
conv2d_2 (Conv2D)            (None, 14, 14, 16)        2320      
_________________________________________________________________
up_sampling2d_1 (UpSampling2 (None, 28, 28, 16)        0         
_________________________________________________________________
conv2d_3 (Conv2D)            (None, 28, 28, 1)         145       
=================================================================
Total params: 5,601
Trainable params: 5,601
Non-trainable params: 0
_________________________________________________________________
None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># в датасете градации серого от 0 до 255</span>
<span class="n">training_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">train_X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>

<span class="c1"># будем обучать только на пятой части датасета - для скорости</span>
<span class="c1"># поскольку у нас классификация - сделаем стратифицированный сплит</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">train_subset_X</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">train_subset_y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">training_set</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">stratify</span><span class="o">=</span><span class="n">train_y</span>
<span class="p">)</span>

<span class="n">autoencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_subset_X</span><span class="p">,</span>
    <span class="n">train_subset_X</span><span class="p">,</span> <span class="c1"># да, здесь y = X, так как это AutoEncoder</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_subset_X</span><span class="p">)</span> <span class="o">//</span> <span class="mi">30</span><span class="p">,</span> <span class="c1"># большой пакет, 400</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">PlotLosses</span><span class="p">()]</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_21_0.png" src="_images/day_4_21_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">fashion</span><span class="p">[</span><span class="n">test_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">fashion</span><span class="p">[</span><span class="n">test_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39; reconstructed&#39;</span><span class="p">);</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">autoencoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">test_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_22_0.png" src="_images/day_4_22_0.png" />
</div>
</div>
<p>Замечательно (хотя и не очень), мы обучили автоэнкодер. Автоэнкодеры сами по себе не очень полезны, разве что в случае чистки изображений от шумов (для этого на вход при обучении подают зашумленные изображения, а как выход - чистые). Но и без этого попробуем.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">noised_sample</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">height</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">noised_sample</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">width</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">noised_sample</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">noised_sample</span><span class="p">[</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">fashion</span><span class="p">[</span><span class="n">test_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39; with noise&#39;</span><span class="p">);</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">noised_sample</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">fashion</span><span class="p">[</span><span class="n">test_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39; reconstructed&#39;</span><span class="p">);</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">autoencoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">noised_sample</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_24_0.png" src="_images/day_4_24_0.png" />
</div>
</div>
<p>Но они более полезны тем, что у нас есть трехмерное представление каждого изображения!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">noised_sample</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.7776766419410706, 6.231951713562012, 2.0251681804656982]
</pre></div>
</div>
</div>
</div>
<p>Давайте посмотрим, что представляют собой полученные вектора на тестовом множестве, и сразу отобразим метки классов.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

<span class="n">test_vectors</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">test_vectors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">test_vectors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">test_vectors</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">test_y</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_28_0.png" src="_images/day_4_28_0.png" />
</div>
</div>
<p>Вот по таким у нас получилось “полочкам” всё разложилось.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet&#39;</span><span class="p">)(</span><span class="n">color</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)))</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">fashion</span><span class="p">[</span><span class="n">color</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_30_0.png" src="_images/day_4_30_0.png" />
</div>
</div>
<p>Дальше можно либо кластеризовывать, либо строить классификатор. Попробуем и кластеризацию (тестового множества), и классификацию.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_vectors</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">)</span>

<span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">train_vectors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">train_vectors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">train_vectors</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">train_y</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_32_0.png" src="_images/day_4_32_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hdbscan</span> <span class="kn">import</span> <span class="n">HDBSCAN</span> <span class="c1"># библиотека быстрой кластеризации</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_score</span>

<span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
<span class="n">best_number</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">best_size</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">min_size</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]:</span>
    <span class="n">clusterer</span> <span class="o">=</span> <span class="n">HDBSCAN</span><span class="p">(</span><span class="n">min_cluster_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">test_vectors</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clusterer</span><span class="o">.</span><span class="n">labels_</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">test_vectors</span><span class="p">,</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
        <span class="n">best_size</span> <span class="o">=</span> <span class="n">min_size</span>
        <span class="n">best_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clusterer</span><span class="o">.</span><span class="n">labels_</span><span class="p">))</span>

<span class="s1">&#39;best clusters number </span><span class="si">%d</span><span class="s1"> with min cluster size = </span><span class="si">%d</span><span class="s1"> and score </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">best_number</span><span class="p">,</span> <span class="n">best_size</span><span class="p">,</span> <span class="n">best_score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;best clusters number 4 with min cluster size = 200 and score 0.07&#39;
</pre></div>
</div>
</div>
</div>
<p>Как видим, разложилось всё как-то не по 10 полочкам. Ладно…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>

<span class="n">classifier</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_vectors</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_vectors</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<span class="s2">&quot;logreg acc </span><span class="si">%.2f</span><span class="s2">, knn acc </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_vectors</span><span class="p">,</span> <span class="n">test_y</span><span class="p">),</span>
    <span class="n">knn</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_vectors</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;logreg acc 0.68, knn acc 0.69&#39;
</pre></div>
</div>
</div>
</div>
<p>Ради интереса, я скачал первые две попавшиеся картинки с wildberries (не реклама!), и обрезал их как можно ближе к квадрату.</p>
<p><img alt="Test1" src="_images/test_1_square.jpg" /></p>
<blockquote>
<div><p>Квадратные штаны не получились</p>
</div></blockquote>
<p><img alt="Test2" src="_images/test_2_square.jpg" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># скормим их нашему классификатору!</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">test_1</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;media/test_1_square.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="c1"># grayscale</span>
<span class="n">test_1</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_1</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">255.</span>

<span class="n">test_2</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;media/test_2_square.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
<span class="n">test_2</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_2</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">255.</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_37_0.png" src="_images/day_4_37_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fashion</span><span class="p">[</span>
    <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">],</span> <span class="n">fashion</span><span class="p">[</span>
    <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;Sandal&#39;, &#39;Shirt&#39;)
</pre></div>
</div>
</div>
</div>
<p>С сандалями разобрались, а вот штаны оказались рубашкой. Что ж, такие вот на wildberries штаны (хотя на самом деле они не по центру фото). Я скачал еще классические мужские брюки и отцентрировал их.</p>
<p><img alt="Test 3" src="_images/test_3.jpg" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_3</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;media/test_3.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
<span class="n">test_3</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_3</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">255.</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Вот они: &quot;</span> <span class="o">+</span> <span class="n">fashion</span><span class="p">[</span>
    <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_40_0.png" src="_images/day_4_40_0.png" />
</div>
</div>
<div class="section" id="id4">
<h3>Заключение<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Если поучить подольше, то изображения кучковались бы еще лучше - автоэнкодер бы их сильнее различал. Соответственно и вектора различались бы сильнее. Главное, что векторное представление дает нам некоторое пространство векторов, с которым уже можно работать. И да, чем больше размерность вектора, тем лучше, для отображения же вложений лучше использовать <code class="docutils literal notranslate"><span class="pre">UMAP</span></code>.</p>
</div>
</div>
<div class="section" id="id5">
<h2>4.3 Классификация и сегментация изображений<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Так-так, а зачем нам классифицировать вложения, когда мы можем классифицировать сами изображения? Должно быть проще и точнее.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_classifier</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">number_classes</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">shape</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">number_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="n">classifier</span> <span class="o">=</span> <span class="n">create_classifier</span><span class="p">((</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">classifier</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d (Conv2D)              (None, 28, 28, 8)         80        
_________________________________________________________________
max_pooling2d (MaxPooling2D) (None, 14, 14, 8)         0         
_________________________________________________________________
dropout (Dropout)            (None, 14, 14, 8)         0         
_________________________________________________________________
conv2d_1 (Conv2D)            (None, 14, 14, 8)         584       
_________________________________________________________________
max_pooling2d_1 (MaxPooling2 (None, 7, 7, 8)           0         
_________________________________________________________________
dropout_1 (Dropout)          (None, 7, 7, 8)           0         
_________________________________________________________________
flatten (Flatten)            (None, 392)               0         
_________________________________________________________________
dense (Dense)                (None, 10)                3930      
=================================================================
Total params: 4,594
Trainable params: 4,594
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">training_set</span><span class="p">,</span> 
    <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">train_y</span><span class="p">),</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">PlotLosses</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;acc&#39;</span><span class="p">)]</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_44_0.png" src="_images/day_4_44_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;loss </span><span class="si">%.2f</span><span class="s1">, accuracy </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">test_y</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>313/313 [==============================] - 1s 4ms/step - loss: 62.9446 - acc: 0.8138
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;loss 62.94, accuracy 0.81&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fashion</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">test_1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">],</span> <span class="n">fashion</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">test_2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">],</span> <span class="n">fashion</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">test_3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;Sandal&#39;, &#39;Trouser&#39;, &#39;Trouser&#39;)
</pre></div>
</div>
</div>
</div>
<p>Ну, теперь все штаны стали штанами. Это был пример классификации изображений, то есть каждому изображению мы составляли некоторый класс.</p>
<p>К слову, существуют и методы локальной (одного примера) интепретации для классификаторов изображений, в частности из библиотеки <code class="docutils literal notranslate"><span class="pre">tf-keras-vis</span></code> можно использовать способ <code class="docutils literal notranslate"><span class="pre">gradcam</span></code>. Описывать принцип его работы тут несподручно (вкратце, предсказание “прокручивается” в обратную сторону), проще посмотреть на результаты: отображаются те пиксели входного изображения, которые привели классификатор к конкретному ответу.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tf_keras_vis.gradcam</span> <span class="kn">import</span> <span class="n">GradcamPlusPlus</span>
<span class="kn">from</span> <span class="nn">tf_keras_vis.utils</span> <span class="kn">import</span> <span class="n">normalize</span>

<span class="c1"># подменим активацию последнего слоя</span>
<span class="k">def</span> <span class="nf">model_modifier</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">linear</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="n">gradcam</span> <span class="o">=</span> <span class="n">GradcamPlusPlus</span><span class="p">(</span>
    <span class="n">classifier</span><span class="p">,</span>
    <span class="n">model_modifier</span><span class="p">,</span>
    <span class="n">clone</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">cam</span> <span class="o">=</span> <span class="n">gradcam</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">output</span><span class="p">:</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="c1"># для этой библиотеки это откуда как брать loss</span>
    <span class="n">test_3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">penultimate_layer</span><span class="o">=-</span><span class="mi">1</span> <span class="c1"># заберем последний слой</span>
<span class="p">)</span>

<span class="n">cam</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">cam</span><span class="p">)</span>

<span class="n">heatmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">cam</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">fashion</span><span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">test_3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">heatmap</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_48_0.png" src="_images/day_4_48_0.png" />
</div>
</div>
<p>Существуют и другие задачи с изображениями, детекция объектов например (подсветить рамочкой людей, машины и другое на фото), а так же сегментации. Задача сегментации - это задача отнесения каждого пикселя изображения к некоторому классу, что есть выделение контуров объектов (например кошки или собаки).</p>
<p>Разметка правильных ответов в задаче сегментации называется <em>маской</em>, и представляет собой заполненный и обведенный контур на изображении. На выходе сеть должна выдать нам пустое изображение, но там где должны быть контуры объекта - заполнить пикселы значением 1. То есть на выходе к каждому пикселю идёт сигмоида.</p>
<p>Для решения задачи сегментации была придумана архитектура <code class="docutils literal notranslate"><span class="pre">U-net</span></code>. Писать её сами мы не будем, мы воспользуемся готовым пакетом <code class="docutils literal notranslate"><span class="pre">keras-unet</span></code>.</p>
<p><img alt="UNET" src="_images/unet.png" /></p>
<p>Похожа на автоэнкодер, за исключением наличия сквозных связей. На каком датасете будем пробовать?</p>
<p>Я разметил 7 (семь) фото своей руки с часами, и обвёл как раз контуром сами часы - с помощью открытого приложения <a class="reference external" href="https://github.com/wkentaro/labelme">LabelMe</a>. Будем распознавать часы на руке. Пример маски, наложенной на фото.</p>
<p><img alt="Segment" src="_images/viz.png" /></p>
<p>Можно удивиться, почему семь фото? А больше лень было. Этого же мало?</p>
<p>Нам поможет <em><strong>аугментация</strong></em> - мы будем растягивать, переворачивать и иным образом всячески шевелить одновременно картинку и маску много раз, чтобы разнообразить наш датасет. По идее, это можно делать бесконечно. Важно тут не переусердствовать, нужно чтобы аугментированные всё же соответствовали тому, что бывает в природе. Аугментации, стоит отметить, заодно регуляризуют модель, дополняя данные - вместо переобучения к маленькому датасету, мы имеем возможность “объяснить” сети на большем числе примеров, что же нужно выделять.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filenames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;data/watches/&#39;</span><span class="p">)</span>

<span class="n">input_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;data/watches/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)))</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="s1">&#39;image&#39;</span> <span class="ow">in</span> <span class="n">filename</span>
<span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="n">input_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;data/watches/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)))</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">filename</span>
<span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">input_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">input_masks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_52_0.png" src="_images/day_4_52_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">albumentations</span> <span class="kn">import</span> <span class="n">ShiftScaleRotate</span><span class="p">,</span> <span class="n">HorizontalFlip</span><span class="p">,</span> <span class="n">Compose</span>

<span class="k">def</span> <span class="nf">augment</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Compose</span><span class="p">([</span>
        <span class="n">HorizontalFlip</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">probability</span><span class="p">),</span>
        <span class="n">ShiftScaleRotate</span><span class="p">(</span>
            <span class="n">shift_limit</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="c1"># двигать на 5%</span>
            <span class="n">scale_limit</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="c1"># увеличивать на 20%</span>
            <span class="n">rotate_limit</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="c1"># вращать на 60 градусов</span>
            <span class="n">p</span><span class="o">=</span><span class="n">probability</span>
        <span class="p">)</span>
    <span class="p">])</span>

<span class="n">augmentation</span> <span class="o">=</span> <span class="n">augment</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">augmented</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>

<span class="n">test_images</span> <span class="o">=</span> <span class="n">input_images</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
<span class="n">test_masks</span> <span class="o">=</span> <span class="n">input_masks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>

<span class="c1"># получим 20 * 5 изображений</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_masks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">augmentation</span><span class="p">(</span>
            <span class="n">image</span><span class="o">=</span><span class="n">input_images</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">input_masks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">augmented</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">]</span>
        <span class="n">augmented</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">augmented</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">augmented</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_54_0.png" src="_images/day_4_54_0.png" />
</div>
</div>
<p>Всё, мы готовы учить наш UNET.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras_unet.models</span> <span class="kn">import</span> <span class="n">custom_unet</span>

<span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>

<span class="n">unet</span> <span class="o">=</span> <span class="n">custom_unet</span><span class="p">(</span>
    <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">num_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">num_layers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">output_activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span>
<span class="p">)</span>

<span class="n">unet</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unet</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">augmented</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">augmented</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
100/100 [==============================] - 14s 140ms/step - loss: 0.5716
Epoch 2/10
100/100 [==============================] - 12s 118ms/step - loss: 0.2900
Epoch 3/10
100/100 [==============================] - 12s 119ms/step - loss: 0.1318
Epoch 4/10
100/100 [==============================] - 12s 119ms/step - loss: 0.0646
Epoch 5/10
100/100 [==============================] - 12s 120ms/step - loss: 0.0370
Epoch 6/10
100/100 [==============================] - 12s 119ms/step - loss: 0.0240
Epoch 7/10
100/100 [==============================] - 12s 118ms/step - loss: 0.0190
Epoch 8/10
100/100 [==============================] - 12s 119ms/step - loss: 0.0142
Epoch 9/10
100/100 [==============================] - 12s 119ms/step - loss: 0.0134
Epoch 10/10
100/100 [==============================] - 12s 119ms/step - loss: 0.0097
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Исходное&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Метка&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Предсказание&#39;</span><span class="p">)</span>

<span class="n">prediction</span> <span class="o">=</span> <span class="n">unet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">test_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_58_0.png" src="_images/day_4_58_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Исходное&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_images</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Метка&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_masks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Предсказание&#39;</span><span class="p">)</span>

<span class="n">prediction</span> <span class="o">=</span> <span class="n">unet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">test_images</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_59_0.png" src="_images/day_4_59_0.png" />
</div>
</div>
<p>Вообще, модель на самом деле в часах ничего не понимает. На белый циферблат, скажем, она не сработает (так как не знает что такие бывают). Она реагирует на что-то черное и круглое с серебристыми линиями внутри.</p>
<p>Попробуем на других часах, тоже с черным циферблатом.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;data/watches/check.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">255.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Исходное&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_check</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Предсказание&#39;</span><span class="p">)</span>
<span class="n">prediction</span> <span class="o">=</span> <span class="n">unet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">test_check</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_61_0.png" src="_images/day_4_61_0.png" />
</div>
</div>
<div class="section" id="id6">
<h3>Заключение<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Работа с изображениями не так проста и в случае сегментации не заканчивается предсказанной маской (что с ней делать-то?). Существует библиотека <code class="docutils literal notranslate"><span class="pre">opencv</span></code>, которая содержит огромное количество методов работы с изображением (в основном без машинного обучения). В ней есть в частности метод <code class="docutils literal notranslate"><span class="pre">findContours</span></code>, который находит замкнутые контуры и <code class="docutils literal notranslate"><span class="pre">boundingRect</span></code> - который возвращает окружающий контур прямоугольник. Вот с такими данными уже можно пробовать наводить аналитику.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">contours</span><span class="p">,</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(((</span><span class="n">prediction</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
<span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Bounding box&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_63_0.png" src="_images/day_4_63_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="id7">
<h2>4.4 Готовые нейросети для работы с изображениями<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>Существует ряд архитектур глубоких нейронных сетей для классификации изображений. Как правило, чем больше в сети весов, тем она точнее, но тем дольше она делает своё предсказание. Также существует и датасет <a class="reference external" href="http://www.image-net.org/">Imagenet</a> с несколькими миллионами размеченных по классам изображений.</p>
<p>В <code class="docutils literal notranslate"><span class="pre">keras</span></code> доступен ряд претренированных на Imagenet сетей. Пользоваться ими достаточно просто, но учтите что первый запуск эти самые веса будут скачиваться (несколько десятков-сотен мегабайт).</p>
<p>Посмотрим, что нам скажет сеть NASNetMobile (одна из самых легких) на вот такое изображение.</p>
<p><img alt="Scared_Cat" src="_images/white_cat.jpg" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.applications</span> <span class="kn">import</span> <span class="n">NASNetMobile</span>
<span class="kn">from</span> <span class="nn">keras.applications.nasnet</span> <span class="kn">import</span> <span class="n">preprocess_input</span><span class="p">,</span> <span class="n">decode_predictions</span>

<span class="n">nasnet</span> <span class="o">=</span> <span class="n">NASNetMobile</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s2">&quot;imagenet&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;media/white_cat.jpg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)))</span>
<span class="n">cat_image</span> <span class="o">=</span> <span class="n">preprocess_input</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">cat_image</span><span class="p">]))</span>

<span class="n">cat_image_prediction</span> <span class="o">=</span> <span class="n">nasnet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">cat_image</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Class, Description, Probability&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cat_prediction</span> <span class="ow">in</span> <span class="n">decode_predictions</span><span class="p">(</span><span class="n">cat_image_prediction</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cat_prediction</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Class, Description, Probability
(&#39;n02123394&#39;, &#39;Persian_cat&#39;, 0.09109089)
(&#39;n02124075&#39;, &#39;Egyptian_cat&#39;, 0.07756926)
(&#39;n02123597&#39;, &#39;Siamese_cat&#39;, 0.0772175)
(&#39;n02127052&#39;, &#39;lynx&#39;, 0.06468712)
(&#39;n03930313&#39;, &#39;picket_fence&#39;, 0.05027819)
</pre></div>
</div>
</div>
</div>
<p>Что ж, видим что сеть хоть и не очень уверена в предсказании, класс фото с кошкой она всё же определила.</p>
<p>Существуют готовые сети и для детекции объектов - которые выделяют рамкой (<em>bounding box</em>) объект (то есть решается задача регрессии для координат) и определяют его класс. Одну такую - <strong>YOLO</strong> (you look only once) - мы сейчас и рассмотрим. Она, в свою очередь, обучена уже на другом датасете, который называется <a class="reference external" href="https://cocodataset.org/">COCO</a>.</p>
<p>Для использования YOLO нам понадобится пакет <code class="docutils literal notranslate"><span class="pre">yolov4</span></code> (и веса сети размером около 260 Мб, которые нужно скачать по ссылке из <a class="reference external" href="https://pypi.org/project/yolov4/">описания пакета</a>). Мы так же должны создать (или отредактировать) файл <em>coco.names</em>, содержащий те наименования классов датасета COCO, которые мы хотим распознавать (изначально их порядка 80).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">yolov4.tf</span> <span class="kn">import</span> <span class="n">YOLOv4</span>

<span class="n">yolo</span> <span class="o">=</span> <span class="n">YOLOv4</span><span class="p">()</span>

<span class="n">yolo</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="s2">&quot;data/coco.names&quot;</span>

<span class="n">yolo</span><span class="o">.</span><span class="n">make_model</span><span class="p">()</span>
<span class="n">yolo</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s2">&quot;D:/Downloads/yolov4.weights&quot;</span><span class="p">,</span> <span class="n">weights_type</span><span class="o">=</span><span class="s2">&quot;yolo&quot;</span><span class="p">)</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="n">yolo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;media/white_cat.jpg&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/coco.names&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
    <span class="n">yolo_classes</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">predicted</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bounding box (center x, center y, width, height):&quot;</span><span class="p">,</span> <span class="n">detection</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Class:&quot;</span><span class="p">,</span> <span class="n">yolo_classes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">4</span><span class="p">])])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Probability: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">detection</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bounding box (center x, center y, width, height): [0.62285298 0.50038516 0.71442688 0.96491622]
Class: cat
Probability: 0.9789
</pre></div>
</div>
</div>
</div>
<div class="section" id="id8">
<h3>Заключение<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>Это вообще замечательно, когда есть готовые нейросети. Их даже можно дообучать (<em>fine-tuning</em>). В случае с <code class="docutils literal notranslate"><span class="pre">keras</span></code>, “замораживаются” веса на нескольких начальных слоях, и сеть нужно дообучить сеть под свой датасет (тут на самом деле надо знать что “морозить”). В случае же с YOLO есть свои инструкции (тоже не самые простые).</p>
<p>Готовые сети позволяют делать готовые приложения, и особенно в тех случаях, когда нет своего датасета. Можно же не распознавать котиков, а, например, только машины. Что с ними сдетектированными делать - это уже зависит только от разбега фантазии.</p>
<p>Для использования готовых нейросетей удобно использовать “зоопарк” моделей сайта <code class="docutils literal notranslate"><span class="pre">TensorflowHub</span></code>. Загляните туда, и (возможно) не пожалеете.</p>
</div>
</div>
<div class="section" id="id9">
<h2>4.5 Тексты и нейросети<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>Вот и подобрались к работе с текстами. Здесь мы будем рассматривать только готовые и очень “толстые” сети. В частности <code class="docutils literal notranslate"><span class="pre">Google</span> <span class="pre">BERT</span></code> (<em>Bidirectional Encoder Representations from Transformers</em>).</p>
<p><code class="docutils literal notranslate"><span class="pre">BERT</span></code> имеет очень большой размер, и был обучен на текстах Википедии решать две задачи:</p>
<ol class="simple">
<li><p>Предсказывать пропущенные слова в тексте: “я пошел в ? и купил ?” - “я пошел в магазин и купил молоко”,</p></li>
<li><p>Предсказывать, является ли текст продолжением некоторого начала: “я пошел в магазин – и купил молоко” (ok) и “я пошел в магазин – и пингвины не летают” (fail).</p></li>
</ol>
<p>У <code class="docutils literal notranslate"><span class="pre">BERT</span></code> для 2018 года была достаточно инновационная архитектура, в частности использовался <em>Attention</em> (механизм внимания) - это когда накапливается информация о последовательных данных (словах). Основное что может <code class="docutils literal notranslate"><span class="pre">BERT</span></code> - это выдать репрезентацию, или вложение слов в векторное пространство, с которым можно работать. Так же <code class="docutils literal notranslate"><span class="pre">BERT</span></code> доучивают под специфические задачи, но это достаточно ресурсозатратное мероприятие (не формата компьютера вида ноутбук).</p>
<p>Модель <code class="docutils literal notranslate"><span class="pre">BERT</span></code> можно предварительно <a class="reference external" href="https://github.com/google-research/bert/blob/master/multilingual.md">скачать</a>, но и <code class="docutils literal notranslate"><span class="pre">deeppavlov</span></code> это умеет сам.</p>
<p>Особенность ряда предобученных вариантов <code class="docutils literal notranslate"><span class="pre">BERT</span></code> - мультиязычность, то есть поддержка сразу около 100 языков “из коробки”. Давайте посмотрим на примерах что может <code class="docutils literal notranslate"><span class="pre">BERT</span></code>, и будем делать это с помощью библиотеки <code class="docutils literal notranslate"><span class="pre">deeppavlov</span></code>, созданной в МФТИ.</p>
<blockquote>
<div><p><strong>Attention!</strong> Для deeppavlov требуется <code class="docutils literal notranslate"><span class="pre">tensorflow==1.15.2</span></code>.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">tf</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">deeppavlov.core.common.file</span> <span class="kn">import</span> <span class="n">read_json</span>
<span class="kn">from</span> <span class="nn">deeppavlov</span> <span class="kn">import</span> <span class="n">build_model</span><span class="p">,</span> <span class="n">configs</span>

<span class="n">bert_config</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">configs</span><span class="o">.</span><span class="n">embedder</span><span class="o">.</span><span class="n">bert_embedder</span><span class="p">)</span>
<span class="n">bert_config</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">][</span><span class="s1">&#39;BERT_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;d:/workspace/bert/bert-base-multilingual-cased/&#39;</span>

<span class="n">bert</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">bert_config</span><span class="p">)</span>

<span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Привет, я предложение.&#39;</span><span class="p">,</span> <span class="s1">&#39;Hello, I</span><span class="se">\&#39;</span><span class="s1">am a sentence too.&#39;</span><span class="p">,</span> <span class="s1">&#39;Тут случайно что-то написано.&#39;</span><span class="p">]</span>
<span class="n">tokens</span><span class="p">,</span> <span class="n">token_embeddings</span><span class="p">,</span> <span class="n">subtokens</span><span class="p">,</span> <span class="n">subtoken_embs</span><span class="p">,</span> <span class="n">sent_max_embs</span><span class="p">,</span> <span class="n">sentence_mean_embeddings</span><span class="p">,</span> <span class="n">bert_pooler_outputs</span> <span class="o">=</span> <span class="n">bert</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Нас будут интересовать <code class="docutils literal notranslate"><span class="pre">token_embeddings</span></code> и <code class="docutils literal notranslate"><span class="pre">sentence_mean_embeddings</span></code>, а точнее косинусное сходство между ними. По аналогии с <code class="docutils literal notranslate"><span class="pre">TFIDF</span></code> - <code class="docutils literal notranslate"><span class="pre">BERT</span></code> лучше работает с косинусным сходством (то есть <code class="docutils literal notranslate"><span class="pre">+1</span></code> - для идентичных примеров, <code class="docutils literal notranslate"><span class="pre">-1</span></code> - для противоположных по смыслу).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">token_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((5, 768), (768,))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Для первого слова!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cosine_similarity</span><span class="p">([</span><span class="n">token_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">token_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cosine_similarity</span><span class="p">([</span><span class="n">token_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">token_embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cosine_similarity</span><span class="p">([</span><span class="n">token_embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">token_embeddings</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cosine_similarity</span><span class="p">([</span><span class="n">token_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">token_embeddings</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Для первого слова!
Привет Привет 1.000
Привет Hello 0.447
Hello Тут 0.354
Привет Тут 0.379
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Средние вложения для предложений&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cosine_similarity</span><span class="p">([</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">texts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cosine_similarity</span><span class="p">([</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">texts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cosine_similarity</span><span class="p">([</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">2</span><span class="p">]]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">texts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cosine_similarity</span><span class="p">([</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">2</span><span class="p">]]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Средние вложения для предложений
Привет, я предложение. Привет, я предложение. 1.000
Привет, я предложение. Hello, I&#39;am a sentence too. 0.579
Hello, I&#39;am a sentence too. Тут случайно что-то написано. 0.484
Привет, я предложение. Тут случайно что-то написано. 0.522
</pre></div>
</div>
</div>
</div>
<p>Кстати, если вектора преобразовать (разделить на их евклидову длину) - то косинусное расстояние будет выражаться через евклидово расстояние векторов.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">euclidean_distances</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Неотнормированные вектора&#39;</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">texts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;euclidean </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">euclidean_distances</span><span class="p">([</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Нормированные вектора&#39;</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">texts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;euclidean </span><span class="si">%.3f</span><span class="s2">, cosine </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">euclidean_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)],</span>
    <span class="p">[</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)]</span>
<span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">euclidean_distances</span><span class="p">(</span>
    <span class="p">[</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)],</span>
    <span class="p">[</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sentence_mean_embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)]</span>
<span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Неотнормированные вектора Привет, я предложение. Hello, I&#39;am a sentence too. euclidean 10.715
Нормированные вектора Привет, я предложение. Hello, I&#39;am a sentence too. euclidean 0.917, cosine 0.579
</pre></div>
</div>
</div>
</div>
<p>Что из этого важно. Важно то, что близкие по смыслу предложения имеют более близкое к 1 расстояние. На этом можно строить кластеризацию, классификаторы даже без <em>fine-tuning</em> <code class="docutils literal notranslate"><span class="pre">BERT</span></code>. Кроме <code class="docutils literal notranslate"><span class="pre">BERT</span></code> существует еще одна модель от Google: <code class="docutils literal notranslate"><span class="pre">USE</span></code> (<em>Universal Sentence Encoder</em>), которая построена на тех же принципах, но уже работает с предложениями (то есть вектор-вложение для “пропущенного” предложения).</p>
<blockquote>
<div><p>Если необходимо работать со смыслом предложений, рекомендую пакет <code class="docutils literal notranslate"><span class="pre">sentence-transformers</span></code>, в нём есть дистиллированная многоязычная модель <code class="docutils literal notranslate"><span class="pre">USE</span></code>.
Дистиллированная - это значит обучена более легкая модель, которая предсказывает то же, что и оригинальная (обычно качество у них чуть хуже, но зато скорость выше и размер ниже).
Однако учтите - “под капотом” у <code class="docutils literal notranslate"><span class="pre">sentence-transformers</span></code> другая библиотека дифференцирования на графах, уже не от Google, а от Facebook, и называется она <code class="docutils literal notranslate"><span class="pre">pytorch</span></code>. Тем не менее, у <code class="docutils literal notranslate"><span class="pre">sentence-transformers</span></code> весьма простой программный интерфейс, и её применение (в том числе благодаря её документации) не составит большого труда.</p>
</div></blockquote>
<p>Но мы даже с помощью <code class="docutils literal notranslate"><span class="pre">BERT</span></code> - благодаря идее ближайших - сможем построить простого вопросно-ответного бота.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">question_answers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Кто первым полетел в космос?&#39;</span><span class="p">,</span> <span class="s1">&#39;Юрий Гагарин&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Кто был первым президентом России?&#39;</span><span class="p">,</span> <span class="s1">&#39;Михаил Горбачев&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Зачем автомобилю руль?&#39;</span><span class="p">,</span> <span class="s1">&#39;Чтобы водитель мог поворачивать&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">qa_vectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">bert</span><span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">question_answers</span>
<span class="p">]</span>

<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="n">knowledge_base</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">qa_vectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">question</span> <span class="o">=</span> <span class="s1">&#39;Кто был первым космонавтом?&#39;</span>

<span class="n">answer_index</span> <span class="o">=</span> <span class="n">knowledge_base</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span>
    <span class="p">[</span><span class="n">bert</span><span class="p">(</span><span class="n">question</span><span class="p">)[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">question_answers</span><span class="p">[</span><span class="n">answer_index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Кто был первым космонавтом? Юрий Гагарин
</pre></div>
</div>
</div>
</div>
<p>Если всё вам нужен чат-бот (а не просто вопросно-ответный), рекомедую забить в поиск Google слова <code class="docutils literal notranslate"><span class="pre">rasa</span> <span class="pre">nlu</span></code>, и присмотреться к набору библиотек и инструментов <code class="docutils literal notranslate"><span class="pre">rasa</span></code>. Они строят чат-ботов на основе историй, извлекая из предложений <strong>намерение</strong> (<em>intent</em>) и <strong>сущности</strong> (<em>entities</em>), например для предложения “где ближайший ресторан” будет распознано намерение “поиск” и сущность “ресторан”.</p>
<p>Из интересного - работа с текстом далеко не ограничивается поиском ближайших. Мы посмотрим еще две задачи - суммаризация (извлечение основного из текста) и извлечение именованных сущностей (<em>named entity recognition</em>). Первая задачу можно решить с помощью пакета <code class="docutils literal notranslate"><span class="pre">bert-extractive-summarizer</span></code>. Он для извлечения основных предложений кластеризует их все, и выбирает самые близкие к центрам кластеров.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># для подгрузки произвольных моделей нужен пакет transformers</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoConfig</span><span class="p">,</span> <span class="n">AutoModel</span><span class="p">,</span> <span class="n">AutoTokenizer</span>

<span class="n">custom_config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;d:/workspace/bert/bert-base-multilingual-cased/&#39;</span><span class="p">)</span>
<span class="n">custom_config</span><span class="o">.</span><span class="n">output_hidden_states</span><span class="o">=</span><span class="kc">True</span>
<span class="n">custom_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;d:/workspace/bert/bert-base-multilingual-cased/&#39;</span><span class="p">)</span>
<span class="n">custom_model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;d:/workspace/bert/bert-base-multilingual-cased/&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">custom_config</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">summarizer</span> <span class="kn">import</span> <span class="n">Summarizer</span>

<span class="n">summarizer</span> <span class="o">=</span> <span class="n">Summarizer</span><span class="p">(</span><span class="n">custom_model</span><span class="o">=</span><span class="n">custom_model</span><span class="p">,</span> <span class="n">custom_tokenizer</span><span class="o">=</span><span class="n">custom_tokenizer</span><span class="p">)</span>

<span class="c1"># https://lenta.ru/news/2020/07/04/cometa/</span>
<span class="n">long_news_text_from_lenta_ru</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Российский космонавт Иван Вагнер, находящийся в настоящее время на Международной космической станции (МКС),</span>
<span class="s2">сфотографировал комету C/2020 F3 (NEOWISE). Он опубликовал фото на своей странице в Twitter. «На следующем витке</span>
<span class="s2">попробовал чуть ближе сфотографировать самую яркую за последние семь лет комету C/2020 F3 (NEOWISE).</span>
<span class="s2">Довольно хорошо видно ее хвост из космоса, с борта Международной космической станции!» — подписал он снимок.</span>
<span class="s2">В ближайшие дни комету можно будет увидеть с Земли в небе над северо-восточным горизонтом недалеко от созвездия Возничего.</span>
<span class="s2">Ранее Вагнер рассказал о сложностях жизни в невесомости. По его словам, самым тяжелым является «длительная изоляция в замкнутом объеме» и бытовые условия.</span>
<span class="s2">На данный момент Иван Вагнер входит в состав экипажа МКС вместе с Анатолием Иванишиным, а также астронавтами НАСА Кристофером Кэссиди, Дугласом Херли</span>
<span class="s2">и Робертом Бенкен. Они продолжают осуществлять свою экспедицию по запланированной программе.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">summarized</span> <span class="o">=</span> <span class="n">summarizer</span><span class="p">(</span><span class="n">long_news_text_from_lenta_ru</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summarized</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Российский космонавт Иван Вагнер, находящийся в настоящее время на Международной космической станции (МКС),
сфотографировал комету C/2020 F3 (NEOWISE).
</pre></div>
</div>
</div>
</div>
<p>Этот способ имеет ряд настроек (например пропорцию сокращения или минимальную длину предложения), и очень удобен для обработки длинных текстов автоматизированно.</p>
<p>А вот NER есть и в уже упомянутой библиотеке <code class="docutils literal notranslate"><span class="pre">deeppavlov</span></code>, и работает он весьма интересно. Посмотрим.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ner</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">configs</span><span class="o">.</span><span class="n">ner</span><span class="o">.</span><span class="n">ner_ontonotes_bert_mult</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ner</span><span class="p">([</span><span class="s1">&#39;Российский космонавт Иван Вагнер, находящийся в настоящее время на Международной космической станции (МКС), сфотографировал комету C/2020 F3 (NEOWISE).&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2020-07-06 12:20:55.155 INFO in &#39;deeppavlov.core.data.simple_vocab&#39;[&#39;simple_vocab&#39;] at line 115: [loading vocabulary from C:\Users\Sazonov_AV\.deeppavlov\models\ner_ontonotes_bert_mult\tag.dict]
2020-07-06 12:21:21.777 INFO in &#39;deeppavlov.core.models.tf_model&#39;[&#39;tf_model&#39;] at line 51: [loading model from C:\Users\Sazonov_AV\.deeppavlov\models\ner_ontonotes_bert_mult\model]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[[&#39;Российский&#39;, &#39;космонавт&#39;, &#39;Иван&#39;, &#39;Вагнер&#39;, &#39;,&#39;, &#39;находящийся&#39;, &#39;в&#39;, &#39;настоящее&#39;, &#39;время&#39;, &#39;на&#39;, &#39;Международной&#39;, &#39;космической&#39;, &#39;станции&#39;, &#39;(&#39;, &#39;МКС&#39;, &#39;)&#39;, &#39;,&#39;, &#39;сфотографировал&#39;, &#39;комету&#39;, &#39;C&#39;, &#39;/&#39;, &#39;2020&#39;, &#39;F3&#39;, &#39;(&#39;, &#39;NEOWISE&#39;, &#39;)&#39;, &#39;.&#39;]], [[&#39;B-NORP&#39;, &#39;O&#39;, &#39;B-PERSON&#39;, &#39;I-PERSON&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;B-ORG&#39;, &#39;I-ORG&#39;, &#39;I-ORG&#39;, &#39;O&#39;, &#39;B-ORG&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;B-LOC&#39;, &#39;I-LOC&#39;, &#39;I-LOC&#39;, &#39;I-LOC&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]]]
</pre></div>
</div>
</div>
</div>
<p>Здесь <code class="docutils literal notranslate"><span class="pre">B</span></code> - начало токена, <code class="docutils literal notranslate"><span class="pre">I</span></code> - продолжение, <code class="docutils literal notranslate"><span class="pre">O</span></code> - не именованная сущность. <code class="docutils literal notranslate"><span class="pre">NORP</span></code> - это национальная, политическая или религиозная принадлежность, <code class="docutils literal notranslate"><span class="pre">PERSON</span></code> - имена людей, <code class="docutils literal notranslate"><span class="pre">ORG</span></code> - понятно, организации, <code class="docutils literal notranslate"><span class="pre">LOC</span></code> - местоположение, и есть и другие типы именованных сущностей (всего 18 в этой модели).</p>
<p>Учтите, нельзя полагаться на NER в том смысле, что он “точно ничего не пропустит”. Мало того что может пропустить, может еще и перепутать. Поэтому использовать его надо не на точность, а на так сказать “ковровое покрытие” - обрабатывать множество текстов и извлекать статистики.</p>
<div class="section" id="id10">
<h3>Заключение<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Языковые модели очень тяжелые и работают достаточно долго (без подключения графических карт). Зато они могут практически чудеса, и этим надо обязательно пользоваться.</p>
</div>
</div>
<div class="section" id="id11">
<h2>4.6 Рекуррентные нейросети для временных рядов<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p>В прошлом дне мы “стэкали” <code class="docutils literal notranslate"><span class="pre">fbprophet</span></code> для получения прогноза на будущее. Можно ли делать подобное одной (нейро-)сетью? Да, можно. Для этого используются <em>рекуррентные слои</em>: такие как <code class="docutils literal notranslate"><span class="pre">LSTM</span></code> (<em>long-short-term memory</em>) или <code class="docutils literal notranslate"><span class="pre">GRU</span></code> (<em>gated recurrent unit</em>). Они требуют на входе последовательности признаков, а не просто одного вектора, то есть размерность их входа <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">T,</span> <span class="pre">C)</span></code>, где <code class="docutils literal notranslate"><span class="pre">B</span></code> - размер батча, <code class="docutils literal notranslate"><span class="pre">T</span></code> - длина серии, <code class="docutils literal notranslate"><span class="pre">C</span></code> - количество признаков в каждый момент времени.</p>
<p>Посмотрим на устройство <code class="docutils literal notranslate"><span class="pre">GRU</span></code> (он проще, и поэтому он часто лучше работает на более коротких по времени данных).
<img alt="GRU" src="_images/gru.svg" /></p>
<p>Здесь:</p>
<ol class="simple">
<li><p>На вход подаются предыдущее <code class="docutils literal notranslate"><span class="pre">h(t</span> <span class="pre">-</span> <span class="pre">1)</span></code> и текущий вектор признаков <code class="docutils literal notranslate"><span class="pre">x(t)</span></code>,</p></li>
<li><p>Они каждый умножаются на свои матрицы весов и сдвигаются на вектор смещения, после чего активируются,</p></li>
<li><p>Из них с помощью покомпонентного перемножения и (другой уже) активации формируется промежуточный вектор <code class="docutils literal notranslate"><span class="pre">h_hat(t)</span></code> (“h с крышкой”),</p></li>
<li><p>Затем из линейной комбинации <code class="docutils literal notranslate"><span class="pre">h(t</span> <span class="pre">-</span> <span class="pre">1)</span></code> и <code class="docutils literal notranslate"><span class="pre">h_hat(t)</span></code> формируется уже новый <code class="docutils literal notranslate"><span class="pre">h(t)</span></code> и так же - выходной вектор.</p></li>
</ol>
<p>Непонятно? :) Да, картинка непонятна (это граф операций), формула на словах тоже.</p>
<p>А происходит вот что. При попадании серии в блок <code class="docutils literal notranslate"><span class="pre">GRU</span></code>, предыдущее состояние комбинируется с текущим элементом серии, и комбинация текущего и предыдущего состояния определяет выход. Веса определяются в процессе обучения так, чтобы дать минимум ошибки.</p>
<p><code class="docutils literal notranslate"><span class="pre">GRU</span></code> вообще говоря также возвращает последовательности. Когда нужен только последний вектор, в <code class="docutils literal notranslate"><span class="pre">keras</span></code> можно задать слою настройку <code class="docutils literal notranslate"><span class="pre">return_sequences</span> <span class="pre">=</span> <span class="pre">False</span></code>. Давайте вернемся к нашей погоде в <em>Jena</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">climate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/jena_climate_2009_2016.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date Time&#39;</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;p (mbar)&#39;</span><span class="p">,</span> <span class="s1">&#39;rh (%)&#39;</span><span class="p">,</span> <span class="s1">&#39;wv (m/s)&#39;</span><span class="p">,</span> <span class="s1">&#39;wd (deg)&#39;</span><span class="p">,</span> <span class="s1">&#39;Date Time&#39;</span><span class="p">]</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;T (degC)&#39;</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">climate</span><span class="p">[</span><span class="n">features</span> <span class="o">+</span> <span class="p">[</span><span class="n">target</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date Time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Wall time: 41.9 s
</pre></div>
</div>
</div>
</div>
<p>Заготовим наши серии. На вход будем подавать 180 точек, а на выход попросим 120.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">past_history</span> <span class="o">=</span> <span class="mi">180</span>
<span class="n">future_target</span> <span class="o">=</span> <span class="mi">120</span>

<span class="k">if</span> <span class="s1">&#39;Date Time&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
    <span class="n">features</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Date Time&#39;</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">multivariate_data</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">past_history</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">future_target</span><span class="p">):</span>
        
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">past_history</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>
        
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">future_target</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">past_history</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">future_target</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span>

<span class="n">weather_X</span><span class="p">,</span> <span class="n">weather_y</span> <span class="o">=</span> <span class="n">multivariate_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># отложим тестовое множество</span>
<span class="n">split</span> <span class="o">=</span> <span class="o">-</span><span class="n">future_target</span>

<span class="n">weather_train_X</span><span class="p">,</span> <span class="n">weather_train_y</span> <span class="o">=</span> <span class="n">weather_X</span><span class="p">[:</span><span class="n">split</span><span class="p">],</span> <span class="n">weather_y</span><span class="p">[:</span><span class="n">split</span><span class="p">]</span>
<span class="n">weather_test_X</span><span class="p">,</span> <span class="n">weather_test_y</span> <span class="o">=</span> <span class="n">weather_X</span><span class="p">[</span><span class="n">split</span><span class="p">:],</span> <span class="n">weather_y</span><span class="p">[</span><span class="n">split</span><span class="p">:]</span>

<span class="n">weather_train_X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">weather_train_y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((2501, 180, 4), (2501, 120))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># отмасштабируем наши признаки от 0 до 1</span>

<span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="nb">max</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">serie</span><span class="p">[:,</span> <span class="n">index</span><span class="p">])</span> <span class="k">for</span> <span class="n">serie</span> <span class="ow">in</span> <span class="n">weather_train_X</span><span class="p">])</span> \
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
<span class="p">])</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="nb">min</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">serie</span><span class="p">[:,</span> <span class="n">index</span><span class="p">])</span> <span class="k">for</span> <span class="n">serie</span> <span class="ow">in</span> <span class="n">weather_train_X</span><span class="p">])</span> \
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
<span class="p">])</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span>
    <span class="nb">max</span><span class="p">(</span><span class="n">serie</span><span class="p">)</span> <span class="k">for</span> <span class="n">serie</span> <span class="ow">in</span> <span class="n">weather_train_y</span>
<span class="p">])</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span>
    <span class="nb">min</span><span class="p">(</span><span class="n">serie</span><span class="p">)</span> <span class="k">for</span> <span class="n">serie</span> <span class="ow">in</span> <span class="n">weather_train_y</span>
<span class="p">])</span>

<span class="n">ranged_train_X</span> <span class="o">=</span> <span class="p">(</span><span class="n">weather_train_X</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>
<span class="n">ranged_test_X</span> <span class="o">=</span> <span class="p">(</span><span class="n">weather_test_X</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>

<span class="n">ranged_train_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">weather_train_y</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
<span class="n">ranged_test_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">weather_test_y</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_RNN</span><span class="p">(</span><span class="n">input_shape</span><span class="p">):</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span>
            <span class="mi">30</span><span class="p">,</span> <span class="c1"># размерность выхода</span>
            <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span>
            <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
            <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">future_target</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="c1"># поскольку в рекуррентных слоях могут быть большие градиенты-производные</span>
    <span class="c1"># мы их будем обрезать по величине 1.</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">clipvalue</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="n">rnn</span> <span class="o">=</span> <span class="n">create_RNN</span><span class="p">(</span><span class="n">weather_train_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">rnn</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
gru (GRU)                    (None, 30)                3240      
_________________________________________________________________
dense (Dense)                (None, 60)                1860      
_________________________________________________________________
dense_1 (Dense)              (None, 120)               7320      
=================================================================
Total params: 12,420
Trainable params: 12,420
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rnn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">ranged_train_X</span><span class="p">,</span> <span class="n">ranged_train_y</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
626/626 [==============================] - 24s 38ms/step - loss: 0.0367 - mae: 0.1524
Epoch 2/20
626/626 [==============================] - 25s 40ms/step - loss: 0.0227 - mae: 0.1206
Epoch 3/20
626/626 [==============================] - 26s 41ms/step - loss: 0.0200 - mae: 0.1124
Epoch 4/20
626/626 [==============================] - 26s 42ms/step - loss: 0.0122 - mae: 0.0869
Epoch 5/20
626/626 [==============================] - 28s 45ms/step - loss: 0.0104 - mae: 0.0804
Epoch 6/20
626/626 [==============================] - 28s 44ms/step - loss: 0.0100 - mae: 0.0788
Epoch 7/20
626/626 [==============================] - 26s 42ms/step - loss: 0.0097 - mae: 0.0780
Epoch 8/20
626/626 [==============================] - 26s 42ms/step - loss: 0.0095 - mae: 0.0767
Epoch 9/20
626/626 [==============================] - 28s 44ms/step - loss: 0.0093 - mae: 0.0761
Epoch 10/20
626/626 [==============================] - 29s 46ms/step - loss: 0.0092 - mae: 0.0756
Epoch 11/20
626/626 [==============================] - 27s 44ms/step - loss: 0.0090 - mae: 0.0750
Epoch 12/20
626/626 [==============================] - 27s 44ms/step - loss: 0.0089 - mae: 0.0744
Epoch 13/20
626/626 [==============================] - 28s 45ms/step - loss: 0.0088 - mae: 0.0741
Epoch 14/20
626/626 [==============================] - 26s 42ms/step - loss: 0.0087 - mae: 0.0734
Epoch 15/20
626/626 [==============================] - 26s 41ms/step - loss: 0.0086 - mae: 0.0729
Epoch 16/20
626/626 [==============================] - 26s 41ms/step - loss: 0.0085 - mae: 0.0724
Epoch 17/20
626/626 [==============================] - 24s 39ms/step - loss: 0.0084 - mae: 0.0720
Epoch 18/20
626/626 [==============================] - 24s 39ms/step - loss: 0.0083 - mae: 0.0715
Epoch 19/20
626/626 [==============================] - 26s 41ms/step - loss: 0.0082 - mae: 0.0711
Epoch 20/20
626/626 [==============================] - 24s 38ms/step - loss: 0.0081 - mae: 0.0709
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="s2">&quot;Средняя ошибка в градусах </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">weather_test_y</span><span class="p">,</span> <span class="n">rnn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">ranged_test_X</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">+</span> <span class="n">ymin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Средняя ошибка в градусах 3.1&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="n">past_history</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:],</span>
    <span class="n">dataset</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="n">past_history</span> <span class="o">*</span> <span class="mi">5</span><span class="p">:],</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">);</span>

<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    
    <span class="n">start</span> <span class="o">=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">future_target</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">predicted_weather</span> <span class="o">=</span> <span class="n">rnn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
            <span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">start</span> <span class="o">-</span> <span class="n">past_history</span><span class="p">:</span><span class="n">start</span><span class="p">]</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>
        <span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">past_history</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">+</span> <span class="n">ymin</span>

    <span class="n">started</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="p">[</span><span class="n">started</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">future_target</span><span class="p">)],</span>
        <span class="n">predicted_weather</span>
    <span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/day_4_97_0.png" src="_images/day_4_97_0.png" />
</div>
</div>
<p>Наверное, в 2017 была там тёплая зима. Заметим, что средняя абсолютная ошибка ниже (но и входные данные, и прогноз по длине разные).</p>
<div class="section" id="id12">
<h3>Заключение<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>Для работы с последовательными данными можно применять рекуррентные нейронные сети. Многие считают, что они всё же не очень хорошо работают. Но они, так или иначе, <em>работают</em>, и без всякого стэкинга. Чудес сильно больших от них не стоит ждать, когда целевая величина не является, или не приведена близко к нормально-распределенной (это скорее уже из опыта наблюдение). Тем не менее случаев применения <code class="docutils literal notranslate"><span class="pre">RNN</span></code> большое множество, так как иногда даже какая-то модель лучше вообще её отсутствия.</p>
<blockquote>
<div><p>Как говорил один известный математик (статистик) Джордж Бокс, <strong>“В сущности, все модели неправильны, но некоторые из них полезны”</strong>.</p>
</div></blockquote>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "py35"
        },
        kernelOptions: {
            kernelName: "py35",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'py35'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="day_3.html" title="previous page">День третий - обучение без учителя*</a>
    <a class='right-next' id="next-link" href="day_5.html" title="next page">День пятый - интерпретация, внедрение и другие темы</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Sazonov Andrey<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="_static/js/index.js"></script>
    
  </body>
</html>